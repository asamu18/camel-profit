Project Scan Root: C:\Users\lenovo\Downloads\camel-profit-main
==================================================

File: index.html
--------------------------------------------------
<!doctype html>
<html lang="en">
  <head>
    <script src="https://cdn.tailwindcss.com"></script>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>camel-profit</title>
  </head>
  <body>
    <div id="app"></div>
    <script type="module" src="/src/main.js"></script>
  </body>
</html>


==================================================

File: package.json
--------------------------------------------------
{
  "name": "camel-profit",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "@supabase/supabase-js": "^2.87.1",
    "echarts": "^6.0.0",
    "element-plus": "^2.12.0",
    "vue": "^3.5.24",
    "vue-router": "^4.6.4",
    "xlsx": "^0.18.5"
  },
  "devDependencies": {
    "@vitejs/plugin-vue": "^6.0.1",
    "sass": "^1.96.0",
    "vite": "npm:rolldown-vite@7.2.5"
  },
  "overrides": {
    "vite": "npm:rolldown-vite@7.2.5"
  }
}


==================================================

File: README.md
--------------------------------------------------
# Vue 3 + Vite

This template should help get you started developing with Vue 3 in Vite. The template uses Vue 3 `<script setup>` SFCs, check out the [script setup docs](https://v3.vuejs.org/api/sfc-script-setup.html#sfc-script-setup) to learn more.

Learn more about IDE Support for Vue in the [Vue Docs Scaling up Guide](https://vuejs.org/guide/scaling-up/tooling.html#ide-support).


==================================================

File: vercel.json
--------------------------------------------------
{
  "rewrites": [
    {
      "source": "/api/supabase/:match*",
      "destination": "https://nzxfchqcvlyulnopifon.supabase.co/:match*"
    }
  ]
}

==================================================

File: vite.config.js
--------------------------------------------------
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'

// https://vite.dev/config/
export default defineConfig({
  plugins: [vue()],
})


==================================================

File: src\App.vue
--------------------------------------------------
<template>
  <Login v-if="!session" />
  <div v-else class="min-h-screen bg-[#FDFBF7] pb-24 max-w-md mx-auto shadow-xl border-x border-gray-100">
    <header class="bg-[#8B5E3C] text-white p-6 rounded-b-3xl shadow-lg">
      <h1 class="text-2xl font-bold">é©¼è´¦å®</h1>
      <p class="text-sm opacity-80 mt-1">ç®€å•ã€ç›´ç™½ï¼Œå…»é©¼äººçš„è®°è´¦ç¥å™¨</p>
    </header>

    <main class="p-4">
      <router-view />
    </main>

    <!-- åº•éƒ¨å¯¼èˆª -->
    <nav class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white border-t flex justify-around py-3 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-40">
      <router-link to="/" class="flex flex-col items-center gap-1 text-gray-400" active-class="!text-[#8B5E3C]">
        <el-icon :size="20"><Money /></el-icon><span class="text-[10px] font-medium">é¦–é¡µ</span>
      </router-link>
      <div class="-mt-10">
        <button @click="triggerAddMilk" class="p-4 rounded-full shadow-xl bg-[#F59E0B] text-white border-4 border-white active:scale-95 transition-transform">
          <el-icon :size="24"><Plus /></el-icon>
        </button>
      </div>
      <router-link to="/history" class="flex flex-col items-center gap-1 text-gray-400" active-class="!text-[#8B5E3C]">
        <el-icon :size="20"><Clock /></el-icon><span class="text-[10px] font-medium">å†å²</span>
      </router-link>
    </nav>
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue'
import { supabase } from './lib/supabase'
import Login from './components/Login.vue'
import { Money, Plus, Clock } from '@element-plus/icons-vue'
import { useRouter } from 'vue-router'

const session = ref(null)
const router = useRouter()

const triggerAddMilk = () => {
  // è§¦å‘é¦–é¡µçš„å¼¹çª—é€»è¾‘ï¼Œæˆ–è€…è·³è½¬
  router.push({ path: '/', query: { action: 'addMilk' }})
}

onMounted(() => {
  supabase.auth.getSession().then(({ data }) => { session.value = data.session })
  supabase.auth.onAuthStateChange((_event, _session) => { session.value = _session })
})
</script>

==================================================

File: src\main.js
--------------------------------------------------
import { createApp } from 'vue'
import App from './App.vue'
import ElementPlus from 'element-plus'
import 'element-plus/dist/index.css'
import router from './router' // å¼•å…¥è·¯ç”±

const app = createApp(App)
app.use(ElementPlus)
app.use(router) // æŒ‚è½½è·¯ç”±
app.mount('#app')

==================================================

File: src\router.js
--------------------------------------------------
import { createRouter, createWebHistory } from 'vue-router'
import Dashboard from './components/Dashboard.vue'
import HistoryView from './components/HistoryView.vue' // æ”¹ä¸ºç›´æ¥å¼•å…¥

const routes = [
  { path: '/', component: Dashboard },
  { path: '/history', component: HistoryView } // ä½¿ç”¨ç»„ä»¶
]

const router = createRouter({
  history: createWebHistory(),
  routes
})

export default router

==================================================

File: src\style.css
--------------------------------------------------
:root {
  font-family: system-ui, Avenir, Helvetica, Arial, sans-serif;
  line-height: 1.5;
  font-weight: 400;

  color-scheme: light dark;
  color: rgba(255, 255, 255, 0.87);
  background-color: #242424;

  font-synthesis: none;
  text-rendering: optimizeLegibility;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

a {
  font-weight: 500;
  color: #646cff;
  text-decoration: inherit;
}
a:hover {
  color: #535bf2;
}

body {
  margin: 0;
  display: flex;
  place-items: center;
  min-width: 320px;
  min-height: 100vh;
}

h1 {
  font-size: 3.2em;
  line-height: 1.1;
}

button {
  border-radius: 8px;
  border: 1px solid transparent;
  padding: 0.6em 1.2em;
  font-size: 1em;
  font-weight: 500;
  font-family: inherit;
  background-color: #1a1a1a;
  cursor: pointer;
  transition: border-color 0.25s;
}
button:hover {
  border-color: #646cff;
}
button:focus,
button:focus-visible {
  outline: 4px auto -webkit-focus-ring-color;
}

.card {
  padding: 2em;
}

#app {
  max-width: 1280px;
  margin: 0 auto;
  padding: 2rem;
  text-align: center;
}

@media (prefers-color-scheme: light) {
  :root {
    color: #213547;
    background-color: #ffffff;
  }
  a:hover {
    color: #747bff;
  }
  button {
    background-color: #f9f9f9;
  }
}


==================================================

File: src\api\dataService.js
--------------------------------------------------
import { supabase } from '../lib/supabase'

export const dataService = {
  // è·å–å½“å‰ç”¨æˆ·ID
  async _getUserId() {
    const { data: { user } } = await supabase.auth.getUser()
    return user?.id
  },

  // 1. æ–°å¢æ”¶å…¥ (è‡ªåŠ¨å¸¦å…¥ user_id)
  async addIncome(record) {
    const user_id = await this._getUserId()
    const { data, error } = await supabase.from('income').insert([{ ...record, user_id }]).select()
    if (error) throw error
    return data
  },

  // 2. æ–°å¢æˆæœ¬ (æ”¯æŒæ•°é‡ã€å•ä»·ï¼Œè‡ªåŠ¨å¸¦å…¥ user_id)
  async addCost(record) {
    const user_id = await this._getUserId()
    // record åº”è¯¥åŒ…å« quantity, unit_price, cost_type, category, amount, date
    const { data, error } = await supabase.from('cost').insert([{ ...record, user_id }]).select()
    if (error) throw error
    return data
  },

  // 3. æ›´æ–°è®°å½• (NEW: ç”¨äºè¡Œå†…ç¼–è¾‘)
  async updateRecord(table, id, updates) {
    // table: 'income' æˆ– 'cost'
    const { error } = await supabase
      .from(table)
      .update(updates)
      .eq('id', id)
    
    if (error) throw error
    return true
  },

  // 4. è·å–å†å²åˆ†ç±» (NEW: ç”¨äºè‡ªå®šä¹‰åˆ†ç±»ä¸‹æ‹‰æç¤º)
  async getUniqueCategories(type) {
    const table = type === 'income' ? 'income' : 'cost'
    // è·å–å½“å‰ç”¨æˆ·è¯¥è¡¨ä¸‹æ‰€æœ‰çš„åˆ†ç±»ï¼Œç”¨äºå‰ç«¯å»é‡
    const { data, error } = await supabase.from(table).select('category')
    if (error) return []
    // ç®€å•çš„å»é‡é€»è¾‘
    return [...new Set(data.map(item => item.category))]
  },

  // 5. æŒ‰æœˆä»½è·å– (ä¿æŒä¸å˜)
  async getDataByMonth(monthStr) {
    const [year, month] = monthStr.split('-')
    const lastDay = new Date(year, month, 0).getDate() 
    const startDate = `${monthStr}-01`
    const endDate = `${monthStr}-${lastDay}`

    const [incomeRes, costRes] = await Promise.all([
      supabase.from('income').select('*').gte('date', startDate).lte('date', endDate).order('date', { ascending: false }),
      supabase.from('cost').select('*').gte('date', startDate).lte('date', endDate).order('date', { ascending: false })
    ])

    if (incomeRes.error) throw incomeRes.error
    if (costRes.error) throw costRes.error

    return { income: incomeRes.data, cost: costRes.data }
  },

  // 6. è·å–è¶‹åŠ¿æ•°æ® (ä¿æŒä¸å˜)
  async getTrendData() {
    const d = new Date()
    d.setMonth(d.getMonth() - 5)
    d.setDate(1)
    const startDate = d.toISOString().slice(0, 10)

    const [incomeRes, costRes] = await Promise.all([
      supabase.from('income').select('date, amount').gte('date', startDate),
      supabase.from('cost').select('date, amount').gte('date', startDate)
    ])
    
    return { income: incomeRes.data, cost: costRes.data }
  },
  
  // 7. åˆ é™¤è®°å½• (ä¿æŒä¸å˜)
  async deleteRecord(table, id) {
    const { error } = await supabase.from(table).delete().eq('id', id)
    if (error) throw error
    return true
  }
}

==================================================

File: src\components\AddRecordModal.vue
--------------------------------------------------
<template>
  <el-dialog v-model="visible" :title="sceneTitle" width="90%" style="max-width: 500px;" center destroy-on-close>
    
    <el-form :model="form" label-position="top">
      
      <!-- åœºæ™¯ A: å–å¥¶ (ä¿æŒä¸å˜) -->
      <div v-if="scene === 'å–å¥¶'">
        <!-- ... åŸæœ‰å–å¥¶ä»£ç ä¿æŒä¸å˜ ... -->
         <el-form-item label="æ—¥æœŸ">
           <el-date-picker v-model="form.date" type="date" value-format="YYYY-MM-DD" style="width: 100%" size="large"/>
        </el-form-item>
        <div class="flex gap-4">
          <el-form-item label="æ•°é‡ (å…¬æ–¤)" class="flex-1">
            <el-input-number v-model="form.quantity" :min="1" style="width: 100%" size="large" />
          </el-form-item>
          <el-form-item label="å•ä»· (å…ƒ/å…¬æ–¤)" class="flex-1">
            <el-input-number v-model="form.unit_price" :min="0.1" :precision="2" style="width: 100%" size="large" />
          </el-form-item>
        </div>
        <div class="bg-blue-50 p-3 rounded text-center text-blue-800 font-bold mb-4">
          æ€»æ”¶å…¥: Â¥ {{ (form.quantity * form.unit_price).toFixed(2) }}
        </div>
      </div>

      <!-- ğŸ”´ åœºæ™¯ B: è¿›å¤§è½¦é¥²æ–™ (é‡å†™) ğŸ”´ -->
      <div v-if="scene === 'ä¹°é¥²æ–™'">
        <div class="bg-green-50 p-3 rounded-lg mb-4 text-xs text-green-800 border border-green-200">
          <el-icon><InfoFilled /></el-icon> 
          ç³»ç»Ÿä¼šæ ¹æ®æ‚¨çš„åˆå§‹åŒ–æ¨¡æ¿ï¼Œè‡ªåŠ¨è®¡ç®—è¿™è½¦é¥²æ–™èƒ½åƒå¤šä¹…ã€‚
        </div>

        <el-form-item label="è¿›è´§æ—¥æœŸ">
           <el-date-picker v-model="form.date" type="date" value-format="YYYY-MM-DD" style="width: 100%" size="large"/>
        </el-form-item>
        
        <!-- 1. é€‰æ‹©é¥²æ–™ (ä»æ¨¡æ¿é‡Œè¯»ï¼Œæ–¹ä¾¿è®¡ç®—) -->
        <el-form-item label="é¥²æ–™åç§° (é€‰æ‹©æˆ–è¾“å…¥)">
           <el-select 
             v-model="form.category" 
             filterable 
             allow-create 
             default-first-option
             placeholder="è¯·é€‰æ‹©" 
             size="large"
             style="width: 100%"
             @change="calculateDuration"
           >
             <el-option 
               v-for="item in feedOptions" 
               :key="item.name" 
               :label="item.name" 
               :value="item.name" 
             />
           </el-select>
        </el-form-item>

        <!-- 2. é‡‘é¢ä¸é‡é‡ -->
        <div class="flex gap-3">
          <el-form-item label="æ€»é‡‘é¢ (å…ƒ)" class="flex-1">
            <el-input-number v-model="form.amount" :min="0" style="width: 100%" size="large" @change="calculateDuration" />
          </el-form-item>
          <el-form-item label="æ€»é‡é‡ (å¨)" class="flex-1">
            <el-input-number v-model="form.weight" :min="0" :precision="2" style="width: 100%" size="large" />
          </el-form-item>
        </div>

        <!-- 3. æ™ºèƒ½è®¡ç®—ç»“æœ -->
        <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
          <div class="text-xs text-gray-500 mb-2">åº“å­˜é¢„ä¼° (è‡ªåŠ¨è®¡ç®—)</div>
          
          <div v-if="dailyUsageInfo" class="flex justify-between items-center mb-2 text-sm">
             <span>æ—¥æ¶ˆè€—æ ‡å‡†:</span>
             <span class="font-bold">Â¥{{ dailyUsageInfo.cost }}/å¤© ({{ dailyUsageInfo.weight }}kg)</span>
          </div>

          <el-form-item label="é¢„è®¡å¯ç”¨å¤©æ•°" class="mb-0">
             <el-slider v-model="form.duration" :min="1" :max="365" show-input />
          </el-form-item>
          <div class="text-right text-xs text-orange-500 mt-1" v-if="form.duration > 0">
            çº¦ {{ (form.duration/30).toFixed(1) }} ä¸ªæœˆ
          </div>
        </div>
      </div>

      <!-- åœºæ™¯ C: éª†é©¼äº¤æ˜“ (ä¿æŒä¸å˜) -->
      <div v-if="scene === 'éª†é©¼äº¤æ˜“'">
        <el-tabs type="card" v-model="camelType">
          <el-tab-pane label="å–éª†é©¼ (æ”¶å…¥)" name="sell"></el-tab-pane>
          <el-tab-pane label="ä¹°éª†é©¼ (æ”¯å‡º)" name="buy"></el-tab-pane>
        </el-tabs>
        <el-form-item label="äº¤æ˜“æ—¥æœŸ">
           <el-date-picker v-model="form.date" type="date" value-format="YYYY-MM-DD" style="width: 100%" size="large" />
        </el-form-item>
        <el-form-item label="æ•°é‡ (å¤´/å³°)">
          <el-input-number v-model="form.quantity" :min="1" style="width: 100%" size="large" />
        </el-form-item>
        <el-form-item label="æ€»é‡‘é¢ (å…ƒ)">
          <el-input-number v-model="form.amount" :min="0" style="width: 100%" size="large" />
        </el-form-item>
      </div>

      <!-- åœºæ™¯ D: å…¶ä»– (ä¿æŒä¸å˜) -->
      <div v-if="scene === 'å…¶ä»–'">
        <el-radio-group v-model="form.type" class="mb-4">
          <el-radio-button label="income">æ”¶å…¥</el-radio-button>
          <el-radio-button label="cost">æ”¯å‡º</el-radio-button>
        </el-radio-group>
        <el-form-item label="é¡¹ç›®åç§°">
          <el-input v-model="form.category" placeholder="å¦‚ï¼šå…½è¯ã€æ°´ç”µè´¹" size="large" />
        </el-form-item>
        <el-form-item label="é‡‘é¢">
          <el-input-number v-model="form.amount" :min="0" style="width: 100%" size="large" />
        </el-form-item>
        <el-form-item label="æ—¥æœŸ">
           <el-date-picker v-model="form.date" type="date" value-format="YYYY-MM-DD" style="width: 100%" size="large" />
        </el-form-item>
      </div>

    </el-form>

    <template #footer>
      <el-button @click="visible = false" size="large">å–æ¶ˆ</el-button>
      <el-button type="primary" :loading="loading" @click="submit" size="large" class="w-32">
        ç¡®è®¤
      </el-button>
    </template>
  </el-dialog>
</template>

<script setup>
import { ref, reactive, computed } from 'vue'
import { dataService } from '../api/dataService'
import { supabase } from '../lib/supabase' // å¼•å…¥ supabase
import { ElMessage } from 'element-plus'
import { InfoFilled } from '@element-plus/icons-vue'

const visible = ref(false)
const scene = ref('å–å¥¶') 
const loading = ref(false)
const camelType = ref('sell') 
const emit = defineEmits(['success'])

// å­˜å‚¨ç”¨æˆ·çš„è®¾ç½®æ¨¡æ¿ï¼Œç”¨äºè®¡ç®—é¥²æ–™æ¶ˆè€—
const userTemplate = ref([])

const form = reactive({
  date: '', quantity: 1, unit_price: 30, amount: 0, category: '', type: 'income', duration: 30, weight: 0
})

// è¿‡æ»¤å‡ºæ¨¡æ¿é‡Œçš„é¥²æ–™é€‰é¡¹
const feedOptions = computed(() => {
  return userTemplate.value.filter(item => 
    item.name.includes('è‰') || 
    item.name.includes('æ–™') || 
    item.name.includes('è±†') || 
    item.name.includes('ç‰ç±³')
  )
})

// å½“å‰é€‰ä¸­çš„é¥²æ–™çš„æ—¥æ¶ˆè€—ä¿¡æ¯
const dailyUsageInfo = computed(() => {
  if (scene.value !== 'ä¹°é¥²æ–™' || !form.category) return null
  const tplItem = userTemplate.value.find(i => i.name === form.category)
  if (!tplItem) return null
  return {
    cost: (tplItem.quantity * tplItem.unit_price).toFixed(0),
    weight: tplItem.quantity // å‡è®¾æ¨¡æ¿é‡Œçš„ quantity å°±æ˜¯æ¯å¤©å–‚çš„å…¬æ–¤æ•°/å•ä½æ•°
  }
})

const sceneTitle = computed(() => {
  return { 'å–å¥¶': 'ä»Šæ—¥å–å¥¶', 'ä¹°é¥²æ–™': 'è¿›å¤§è½¦é¥²æ–™', 'éª†é©¼äº¤æ˜“': 'éª†é©¼ä¹°å–', 'å…¶ä»–': 'è®°ä¸€ç¬”' }[scene.value]
})

// æ‰“å¼€å¼¹çª—æ—¶ï¼Œå…ˆå»æ‹‰å–æœ€æ–°çš„è®¾ç½®ï¼Œä¸ºäº†è®¡ç®—å‡†
const openWithScene = async (s) => {
  scene.value = s
  visible.value = true
  
  // é‡ç½®è¡¨å•
  form.date = new Date().toISOString().slice(0, 10)
  form.amount = 0
  form.quantity = 1
  form.duration = 30 
  form.weight = 0
  form.category = ''

  if (s === 'å–å¥¶') {
    form.category = 'é©¼å¥¶é”€å”®'
    // è¿™é‡Œå¯ä»¥ä¼˜åŒ–ï¼šå»è¯» herdSize é‡Œçš„é»˜è®¤å¥¶ä»·ï¼Œæš‚ç•¥
    form.unit_price = 30 
  }

  // ğŸ”´ å…³é”®ï¼šæ‹‰å–ç”¨æˆ·æ¨¡æ¿ ğŸ”´
  if (s === 'ä¹°é¥²æ–™') {
    const { data: { user } } = await supabase.auth.getUser()
    const { data } = await supabase.from('settings').select('daily_template').eq('user_id', user.id).single()
    if (data && data.daily_template) {
      userTemplate.value = data.daily_template
    }
  }
}

// è‡ªåŠ¨è®¡ç®—æŒç»­å¤©æ•°
const calculateDuration = () => {
  if (!dailyUsageInfo.value || form.amount <= 0) return
  
  const dailyCost = Number(dailyUsageInfo.value.cost)
  if (dailyCost > 0) {
    // æ€»é‡‘é¢ / æ¯å¤©æ¶ˆè€—é‡‘é¢ = èƒ½åƒå‡ å¤©
    const days = Math.round(form.amount / dailyCost)
    form.duration = days > 0 ? days : 1
  }
}

const submit = async () => {
  loading.value = true
  try {
    if (scene.value === 'å–å¥¶') {
      await dataService.addIncome({
        date: form.date, category: 'é©¼å¥¶é”€å”®', 
        quantity: form.quantity, unit_price: form.unit_price, 
        amount: form.quantity * form.unit_price
      })
    } 
    else if (scene.value === 'ä¹°é¥²æ–™') {
      if (!form.category) form.category = 'æœªçŸ¥é¥²æ–™'
      await dataService.addCost({
        date: form.date, 
        category: form.category, 
        amount: form.amount, 
        weight: form.weight, // è®°å½•é‡é‡
        cost_type: 'åº“å­˜è¿›è´§', // æ ‡è®°ç±»å‹
        duration: form.duration // å­˜å…¥å¯ç”¨å¤©æ•° (å½±å“è¿›åº¦æ¡)
      })
    }
    else if (scene.value === 'éª†é©¼äº¤æ˜“') {
      const isSell = camelType.value === 'sell'
      const data = {
        date: form.date, category: isSell ? 'å–éª†é©¼' : 'ä¹°éª†é©¼',
        quantity: form.quantity, amount: form.amount
      }
      if (isSell) await dataService.addIncome(data)
      else await dataService.addCost({ ...data, cost_type: 'å›ºå®šæˆæœ¬' })
    }
    else {
      // å…¶ä»–
      const data = { date: form.date, category: form.category, amount: form.amount }
      if (form.type === 'income') await dataService.addIncome(data)
      else await dataService.addCost({ ...data, cost_type: 'å…¶ä»–' })
    }

    ElMessage.success('è®°å¥½äº†ï¼')
    visible.value = false
    emit('success')
  } catch (e) {
    ElMessage.error(e.message)
  } finally {
    loading.value = false
  }
}

defineExpose({ openWithScene })
</script>

==================================================

File: src\components\Dashboard.vue
--------------------------------------------------
<template>
  <div class="space-y-6">
    <!-- AI å»ºè®®ä½ (æ”¹ä¸ºæœ¬åœ°çŠ¶æ€å»ºè®®) -->
    <div class="bg-amber-50 border border-amber-100 p-4 rounded-2xl flex items-center gap-3">
      <div class="text-2xl">ğŸ«</div>
      <p class="text-amber-900 text-sm font-medium">{{ advice }}</p>
    </div>

    <!-- æ•°æ®çœ‹æ¿ -->
    <div class="grid grid-cols-2 gap-4">
      <div class="bg-white p-5 rounded-3xl shadow-sm border border-gray-50 flex flex-col justify-between h-32 relative overflow-hidden">
        <span class="text-gray-400 text-sm">ä»Šæ—¥äº¤å¥¶æ”¶å…¥</span>
        <span class="text-2xl font-bold text-emerald-500">ï¿¥{{ todayIncome }}</span>
        <div v-if="hasTodayMilk" class="absolute -right-2 -bottom-2 opacity-10 text-emerald-500 scale-150 rotate-12">
          <el-icon :size="60"><CircleCheckFilled /></el-icon>
        </div>
      </div>
      <div class="bg-white p-5 rounded-3xl shadow-sm border border-gray-50 flex flex-col justify-between h-32">
        <span class="text-gray-400 text-sm">æ¯æ—¥å›ºå®šæˆæœ¬</span>
        <span class="text-2xl font-bold text-rose-500">ï¿¥{{ dailyFixedCost }}</span>
      </div>
    </div>

    <!-- åŠ¨æ€åˆ©æ¶¦é¢„ä¼°å¡ç‰‡ -->
    <div class="bg-[#8B5E3C] p-6 rounded-[2.5rem] shadow-xl text-white">
      <div class="flex justify-between items-start mb-4">
        <div>
          <h3 class="text-lg opacity-80">æœ¬æœˆåˆ©æ¶¦ (åŠ¨æ€)</h3>
          <p class="text-3xl font-bold mt-1">ï¿¥{{ formatNum(monthlyProfit) }}</p>
        </div>
        <div class="text-right">
          <span class="text-[10px] bg-white/10 px-2 py-0.5 rounded-full block mb-1">å·²è®¡å…¥å®é™…æ”¶æ”¯</span>
          <span class="text-[10px] text-white/50">æœˆé¢å¤–æ”¯å‡º: ï¿¥{{ monthlyExtra }}</span>
        </div>
      </div>
      <div class="pt-4 border-t border-white/10 flex items-center justify-between">
        <div><p class="text-[10px] opacity-70">é¢„è®¡å¹´åˆ©æ¶¦</p><p class="text-lg font-bold">ï¿¥{{ formatNum(monthlyProfit * 12) }}</p></div>
        <div class="text-right"><p class="text-[10px] opacity-50 italic">*å®é™…æ”¶å…¥è¶Šé«˜ï¼Œé¢„ä¼°è¶Šå‡†</p></div>
      </div>
    </div>

    <!-- å¿«æ·æ“ä½œ -->
    <div class="grid grid-cols-2 gap-4">
      <button @click="openMilk" :class="hasTodayMilk ? 'bg-emerald-500' : 'bg-[#F59E0B]'" class="py-5 rounded-3xl font-bold text-lg shadow-md text-white flex flex-col items-center gap-1">
        <span>{{ hasTodayMilk ? 'âœ… ä»Šæ—¥å·²äº¤' : 'ğŸ¥› åˆšäº¤äº†å¥¶' }}</span>
      </button>
      <button @click="openExtra" class="bg-[#C4A484] text-white py-5 rounded-3xl font-bold text-lg shadow-md flex flex-col items-center gap-1">
        <span>ğŸšœ é¢å¤–å¼€é”€</span>
      </button>
    </div>

    <!-- å¤ç”¨ä½ ä¹‹å‰çš„å¼¹çª— -->
    <AddRecordModal ref="addModalRef" @success="syncData" />
    <SetupWizard ref="wizardRef" @finish="syncData" />
  </div>
</template>

<script setup>
import { ref, onMounted, computed, watch } from 'vue'
import { supabase } from '../lib/supabase'
import { CircleCheckFilled } from '@element-plus/icons-vue'
import AddRecordModal from './AddRecordModal.vue'
import SetupWizard from './SetupWizard.vue'
import { useRoute } from 'vue-router'

const addModalRef = ref(null)
const wizardRef = ref(null)
const route = useRoute()

// æ ¸å¿ƒçŠ¶æ€
const income = ref([])
const cost = ref([])
const settings = ref(null)

// è®¡ç®—å±æ€§
const todayIncome = computed(() => {
  const today = new Date().toISOString().slice(0, 10)
  return income.value.filter(i => i.date === today && i.category === 'é©¼å¥¶é”€å”®').reduce((s, i) => s + i.amount, 0)
})
const hasTodayMilk = computed(() => todayIncome.value > 0)
const dailyFixedCost = computed(() => {
  if (!settings.value?.daily_template) return 0
  return settings.value.daily_template.reduce((s, i) => s + (i.quantity * i.unit_price), 0)
})

const monthlyExtra = computed(() => {
  const now = new Date()
  return cost.value.filter(c => {
    const d = new Date(c.date)
    return d.getMonth() === now.getMonth() && c.cost_type !== 'æ—¥å¸¸æ”¯å‡º'
  }).reduce((s, i) => s + i.amount, 0)
})

const monthlyProfit = computed(() => {
  // ç®€åŒ–ç‰ˆé€»è¾‘ï¼š(å·²æ”¶å¥¶æ¬¾ + é¢„ä¼°å‰©ä½™å¥¶æ¬¾) - (å›ºå®šæˆæœ¬*30) - (æœ¬æœˆé¢å¤–)
  const now = new Date()
  const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate()
  const daysPassed = now.getDate()
  
  const actualMilk = income.value.filter(i => {
    const d = new Date(i.date)
    return d.getMonth() === now.getMonth() && i.category === 'é©¼å¥¶é”€å”®'
  }).reduce((s, i) => s + i.amount, 0)

  const dailyProjectedIncome = settings.value ? (settings.value.milk_quantity_per_time * settings.value.milk_price / (settings.value.milk_frequency || 1)) : 0
  const projectedMilk = (daysInMonth - daysPassed) * dailyProjectedIncome
  
  return (actualMilk + projectedMilk) - (dailyFixedCost.value * daysInMonth) - monthlyExtra.value
})

const advice = computed(() => hasTodayMilk.value ? "ä»Šæ—¥å·²äº¤å¥¶ï¼Œå¹²å¾—æ¼‚äº®ï¼" : "ä»Šå¤©è¿˜æ²¡è®°äº¤å¥¶è´¦å‘¢ï¼Œåˆ«å¿˜äº†å†™ä¸Šä¸€ç¬”ã€‚")

// åŒæ­¥é€»è¾‘
const syncData = async () => {
  const { data: { user } } = await supabase.auth.getUser()
  
  // å¹¶è¡Œæ‹‰å–
  const [incRes, costRes, setRes] = await Promise.all([
    supabase.from('income').select('*').eq('user_id', user.id).order('date', { ascending: false }).limit(100),
    supabase.from('cost').select('*').eq('user_id', user.id).order('date', { ascending: false }).limit(100),
    supabase.from('settings').select('*').eq('user_id', user.id).maybeSingle()
  ])

  if (incRes.data) { income.value = incRes.data; localStorage.setItem('cache_inc', JSON.stringify(incRes.data)) }
  if (costRes.data) { cost.value = costRes.data; localStorage.setItem('cache_cost', JSON.stringify(costRes.data)) }
  if (setRes.data) { settings.value = setRes.data; localStorage.setItem('cache_set', JSON.stringify(setRes.data)) }
}

const openMilk = () => addModalRef.value.openWithScene('å–å¥¶')
const openExtra = () => addModalRef.value.openWithScene('å…¶ä»–')
const formatNum = (n) => Math.max(0, n).toLocaleString(undefined, { maximumFractionDigits: 0 })

onMounted(() => {
  // 1. åŠ è½½ç¼“å­˜ä¿è¯ç§’å¼€
  income.value = JSON.parse(localStorage.getItem('cache_inc') || '[]')
  cost.value = JSON.parse(localStorage.getItem('cache_cost') || '[]')
  settings.value = JSON.parse(localStorage.getItem('cache_set') || 'null')

  // 2. åå°åŒæ­¥äº‘ç«¯
  syncData()
  
  // æ£€æŸ¥å‘å¯¼
  setTimeout(() => { if (wizardRef.value) wizardRef.value.check() }, 1000)
})

// ç›‘å¬å¯¼èˆªè§¦å‘
watch(() => route.query.action, (val) => {
  if (val === 'addMilk') openMilk()
})
</script>

==================================================

File: src\components\EditRecordModal.vue
--------------------------------------------------
<template>
  <el-dialog v-model="visible" :title="isCreateMode ? 'ç¡®è®¤/ä¿®æ”¹æ”¯å‡º' : 'ä¿®æ”¹è´¦å•'" width="90%" style="max-width: 400px;" center destroy-on-close>
    
    <el-form label-position="top">
      
      <!-- 1. åŸºæœ¬ä¿¡æ¯ -->
      <el-form-item label="é¡¹ç›®åç§°">
        <el-input v-model="form.category" size="large" />
      </el-form-item>
      
      <!-- 2. é‡‘é¢ä¿®æ”¹ -->
      <div class="flex gap-3">
        <el-form-item label="å•ä»·" class="flex-1">
          <el-input-number v-model="form.unit_price" :min="0" style="width: 100%" :controls="false" size="large" @change="calcTotal" />
        </el-form-item>
        <el-form-item label="æ•°é‡" class="flex-1">
          <el-input-number v-model="form.quantity" :min="0" style="width: 100%" :controls="false" size="large" @change="calcTotal" />
        </el-form-item>
      </div>

      <el-form-item label="æ€»é‡‘é¢ (å…ƒ)">
        <el-input-number v-model="form.amount" :min="0" :precision="2" style="width: 100%" size="large" />
      </el-form-item>

      <!-- 3. æ—¥æœŸä¿®æ”¹ -->
      <el-form-item label="æ—¥æœŸ">
        <el-date-picker v-model="form.date" type="date" value-format="YYYY-MM-DD" style="width: 100%" size="large" />
      </el-form-item>

      <div v-if="form.weight > 0">
        <el-form-item label="é‡é‡ (å¨)">
          <el-input-number v-model="form.weight" :min="0" :precision="2" style="width: 100%" />
        </el-form-item>
      </div>

    </el-form>

    <template #footer>
      <div class="flex justify-between items-center">
        <!-- åªæœ‰å·²å­˜åœ¨çš„è®°å½•æ‰èƒ½åˆ é™¤ -->
        <el-button v-if="!isCreateMode" type="danger" link @click="handleDelete" :loading="loading">åˆ é™¤æ­¤æ¡</el-button>
        <span v-else></span> <!-- å ä½ç¬¦ -->
        
        <div>
          <el-button @click="visible = false">å–æ¶ˆ</el-button>
          <el-button type="primary" @click="handleSave" :loading="loading">ç¡®å®š</el-button>
        </div>
      </div>
    </template>
  </el-dialog>
</template>

<script setup>
import { ref, reactive, computed } from 'vue'
import { dataService } from '../api/dataService'
import { supabase } from '../lib/supabase'
import { ElMessage, ElMessageBox } from 'element-plus'

const visible = ref(false)
const loading = ref(false)
const emit = defineEmits(['refresh'])

const currentRow = ref(null) 
const form = reactive({ category: '', amount: 0, date: '', quantity: 0, weight: 0, unit_price: 0 })

// åˆ¤æ–­æ¨¡å¼ï¼šæœ‰æ²¡æœ‰ IDï¼Ÿæ—  ID åˆ™æ˜¯ä»æ¨¡æ¿ç‚¹å‡»è¿›æ¥çš„â€œåˆ›å»ºæ¨¡å¼â€
const isCreateMode = computed(() => !currentRow.value?.id)

const open = (row) => {
  currentRow.value = row
  // åˆå§‹åŒ–è¡¨å•
  form.category = row.category
  form.amount = row.amount
  form.date = row.date || new Date().toISOString().slice(0, 10)
  form.quantity = row.quantity || 1
  form.unit_price = row.unit_price || row.amount // å¦‚æœæ²¡æœ‰å•ä»·ï¼Œæš‚æ—¶ç”¨æ€»ä»·ä»£æ›¿
  form.weight = row.weight || 0
  
  visible.value = true
}

const calcTotal = () => {
  form.amount = form.quantity * form.unit_price
}

const handleSave = async () => {
  loading.value = true
  try {
    const table = 'cost' // è¿™é‡Œä¸»è¦æ˜¯æ”¯å‡ºç¼–è¾‘ï¼Œå¦‚æœæ˜¯æ”¶å…¥é€»è¾‘è¦å•ç‹¬åˆ¤æ–­ï¼Œä½†ç›®å‰ä¸»è¦æ˜¯æ”¹æˆæœ¬
    
    if (isCreateMode.value) {
      // --- æ–°å¢æ¨¡å¼ (ä»æ¨¡æ¿è½¬å®è´¦) ---
      const { data: { user } } = await supabase.auth.getUser()
      const record = {
        user_id: user.id,
        date: form.date,
        category: form.category,
        quantity: form.quantity,
        unit_price: form.unit_price,
        amount: form.amount,
        weight: form.weight,
        cost_type: currentRow.value.cost_type || 'æ—¥å¸¸æ”¯å‡º'
      }
      await dataService.addCost(record)
      ElMessage.success('å·²å…¥è´¦')
    } else {
      // --- æ›´æ–°æ¨¡å¼ ---
      await dataService.updateRecord(table, currentRow.value.id, {
        category: form.category,
        amount: form.amount,
        date: form.date,
        quantity: form.quantity,
        unit_price: form.unit_price,
        weight: form.weight
      })
      ElMessage.success('ä¿®æ”¹æˆåŠŸ')
    }

    visible.value = false
    emit('refresh')
  } catch (e) {
    console.error(e)
    ElMessage.error('æ“ä½œå¤±è´¥')
  } finally {
    loading.value = false
  }
}

const handleDelete = () => {
  ElMessageBox.confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ', 'è­¦å‘Š', {
    confirmButtonText: 'åˆ é™¤',
    cancelButtonText: 'å–æ¶ˆ',
    type: 'warning'
  }).then(async () => {
    loading.value = true
    try {
      await dataService.deleteRecord('cost', currentRow.value.id)
      ElMessage.success('åˆ é™¤æˆåŠŸ')
      visible.value = false
      emit('refresh')
    } catch (e) {
      ElMessage.error('åˆ é™¤å¤±è´¥')
    } finally {
      loading.value = false
    }
  }).catch(() => {})
}

defineExpose({ open })
</script>

==================================================

File: src\components\FeedStatModal.vue
--------------------------------------------------
<template>
  <el-dialog v-model="visible" title="é¥²æ–™æˆæœ¬ç»Ÿè®¡" width="90%" center>
    
    <div class="flex gap-2 mb-4">
      <el-date-picker 
        v-model="dateRange" 
        type="daterange" 
        range-separator="è‡³" 
        start-placeholder="å¼€å§‹" 
        end-placeholder="ç»“æŸ"
        value-format="YYYY-MM-DD"
        size="small"
        :clearable="false"
        style="width: 100%"
        @change="fetchStats"
      />
    </div>

    <div v-loading="loading">
      <!-- æ±‡æ€»å¡ç‰‡ -->
      <div class="grid grid-cols-2 gap-3 mb-4">
        <div class="bg-green-50 p-3 rounded-lg text-center border border-green-100">
          <div class="text-xs text-gray-500">æ€»é‡é‡ (å¨)</div>
          <div class="text-xl font-bold text-green-700">{{ totalWeight }}</div>
        </div>
        <div class="bg-orange-50 p-3 rounded-lg text-center border border-orange-100">
          <div class="text-xs text-gray-500">æ€»èŠ±è´¹ (å…ƒ)</div>
          <div class="text-xl font-bold text-orange-700">{{ totalCost }}</div>
        </div>
      </div>

      <!-- åˆ—è¡¨ -->
      <div class="space-y-2 max-h-60 overflow-y-auto">
        <div v-for="(item, idx) in list" :key="idx" class="flex justify-between items-center bg-gray-50 p-2 rounded text-sm">
          <span class="font-bold text-gray-700">{{ item.name }}</span>
          <div class="text-right">
            <div class="text-xs text-gray-500">{{ item.weight }} å¨</div>
            <div class="font-medium text-gray-900">Â¥ {{ item.amount }}</div>
          </div>
        </div>
      </div>
    </div>

  </el-dialog>
</template>

<script setup>
import { ref, computed } from 'vue'
import { supabase } from '../lib/supabase'

const visible = ref(false)
const loading = ref(false)
// é»˜è®¤æŸ¥æœ€è¿‘30å¤©
const end = new Date()
const start = new Date()
start.setDate(start.getDate() - 30)
const dateRange = ref([start.toISOString().slice(0,10), end.toISOString().slice(0,10)])
const rawData = ref([])

const open = () => {
  visible.value = true
  fetchStats()
}

const fetchStats = async () => {
  if (!dateRange.value) return
  loading.value = true
  // æŸ¥æ‰¾æ‰€æœ‰é¥²æ–™ç›¸å…³çš„æ”¯å‡º
  const { data } = await supabase
    .from('cost')
    .select('*')
    .gte('date', dateRange.value[0])
    .lte('date', dateRange.value[1])
    .or('category.ilike.%é¥²æ–™%,category.ilike.%è‰%,category.ilike.%è±†%,category.ilike.%æ–™%') // æ¨¡ç³ŠåŒ¹é…å¸¸è§é¥²æ–™å

  rawData.value = data || []
  loading.value = false
}

const totalWeight = computed(() => rawData.value.reduce((s, i) => s + (Number(i.weight)||0), 0).toFixed(2))
const totalCost = computed(() => rawData.value.reduce((s, i) => s + Number(i.amount), 0).toFixed(0))

// æŒ‰åç§°åˆ†ç»„ç»Ÿè®¡
const list = computed(() => {
  const map = {}
  rawData.value.forEach(i => {
    if (!map[i.category]) map[i.category] = { name: i.category, weight: 0, amount: 0 }
    map[i.category].weight += (Number(i.weight) || 0)
    map[i.category].amount += Number(i.amount)
  })
  return Object.values(map).sort((a,b) => b.amount - a.amount)
})

defineExpose({ open })
</script>

==================================================

File: src\components\HistoryView.vue
--------------------------------------------------
<template>
  <div class="space-y-4 pb-10">
    <div class="flex items-center justify-between mb-2">
      <h2 class="text-xl font-bold text-[#8B5E3C]">è´¦å•æµæ°´</h2>
      <el-tag type="info" size="small" round>æœ€è¿‘ 50 æ¡</el-tag>
    </div>

    <!-- åˆ—è¡¨ä¸ºç©ºæ—¶ -->
    <div v-if="historyList.length === 0" class="flex flex-col items-center justify-center py-20 text-gray-400">
      <el-icon :size="60" class="opacity-20"><Document /></el-icon>
      <p class="mt-2">è¿˜æ²¡æœ‰ä»»ä½•è®°å½•</p>
    </div>

    <!-- è®°å½•åˆ—è¡¨ -->
    <div v-else class="space-y-3">
      <div 
        v-for="item in historyList" 
        :key="item.id" 
        class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex items-center justify-between group animate-in fade-in duration-300"
      >
        <div class="flex items-center gap-4">
          <!-- å›¾æ ‡ -->
          <div :class="item.isIncome ? 'bg-emerald-50 text-emerald-600' : 'bg-rose-50 text-rose-600'" 
               class="w-12 h-12 rounded-full flex items-center justify-center text-xl">
            <span v-if="item.category.includes('å¥¶')">ğŸ¥›</span>
            <span v-else-if="item.category.includes('éª†é©¼')">ğŸ«</span>
            <span v-else-if="item.category.includes('è‰') || item.category.includes('æ–™')">ğŸŒ¿</span>
            <span v-else>ğŸ’°</span>
          </div>

          <div>
            <p class="font-bold text-gray-800">{{ item.category }}</p>
            <p class="text-xs text-gray-400 font-mono">{{ item.date }}</p>
          </div>
        </div>

        <div class="flex flex-col items-end gap-1">
          <p :class="item.isIncome ? 'text-emerald-500' : 'text-rose-500'" class="font-bold text-lg font-mono">
            {{ item.isIncome ? '+' : '-' }}{{ item.amount.toLocaleString() }}
          </p>
          <!-- åˆ é™¤æŒ‰é’® -->
          <button 
            @click="handleDelete(item)"
            class="text-[10px] text-rose-300 hover:text-rose-500 opacity-0 group-hover:opacity-100 transition-opacity"
          >
            åˆ é™¤
          </button>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, onMounted, computed } from 'vue'
import { supabase } from '../lib/supabase'
import { Document } from '@element-plus/icons-vue'
import { ElMessageBox, ElMessage } from 'element-plus'
import { dataService } from '../api/dataService'

const income = ref([])
const cost = ref([])

const historyList = computed(() => {
  const list = [
    ...income.value.map(x => ({ ...x, isIncome: true })),
    ...cost.value.map(x => ({ ...x, isIncome: false }))
  ]
  // æŒ‰æ—¥æœŸé™åºæ’åº
  return list.sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 50)
})

const fetchData = async () => {
  const { data: { user } } = await supabase.auth.getUser()
  if (!user) return

  const [incRes, costRes] = await Promise.all([
    supabase.from('income').select('*').eq('user_id', user.id).order('date', { ascending: false }).limit(50),
    supabase.from('cost').select('*').eq('user_id', user.id).order('date', { ascending: false }).limit(50)
  ])

  income.value = incRes.data || []
  cost.value = costRes.data || []
}

const handleDelete = (item) => {
  ElMessageBox.confirm(
    `ç¡®å®šåˆ é™¤è¿™æ¡ Â¥${item.amount} çš„è®°å½•å—ï¼Ÿ`,
    'æç¤º',
    { confirmButtonText: 'ç¡®å®š', cancelButtonText: 'å–æ¶ˆ', type: 'warning' }
  ).then(async () => {
    const table = item.isIncome ? 'income' : 'cost'
    await dataService.deleteRecord(table, item.id)
    ElMessage.success('å·²åˆ é™¤')
    fetchData() // åˆ·æ–°åˆ—è¡¨
  }).catch(() => {})
}

onMounted(fetchData)
</script>

==================================================

File: src\components\Login.vue
--------------------------------------------------
<template>
  <div class="min-h-screen flex items-center justify-center bg-gray-100 p-4"> <!-- å¢åŠ  p-4 é˜²æ­¢æ‰‹æœºè´´è¾¹ -->
    <div class="bg-white p-8 rounded-xl shadow-md w-full max-w-sm"> <!-- w-96 æ”¹ä¸º max-w-sm é€‚é…å°å± -->
      <div class="flex justify-center mb-4">
        <div class="w-16 h-16 bg-orange-500 rounded-xl flex items-center justify-center text-white font-bold text-3xl">é©¼</div>
      </div>
      <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">é©¼åœºç®¡ç†ç³»ç»Ÿ</h2>
      
      <el-form label-position="top">
        <el-form-item label="æ‰‹æœºå·ç ">
          <el-input 
            v-model="phone" 
            placeholder="è¯·è¾“å…¥11ä½æ‰‹æœºå·" 
            maxlength="11"
            type="tel"
          >
            <template #prefix>+86</template>
          </el-input>
        </el-form-item>
        
        <el-form-item label="ç™»å½•å¯†ç ">
          <el-input 
            v-model="password" 
            type="password" 
            placeholder="è¯·è¾“å…¥å¯†ç " 
            show-password
            @keyup.enter="handleLogin" 
          />
        </el-form-item>
        
        <el-button type="primary" class="w-full mt-4 !h-10 !text-base" :loading="loading" @click="handleLogin">
          ç™»å½• / æ³¨å†Œ
        </el-button>
        <p class="text-xs text-gray-400 mt-4 text-center">
          é¦–æ¬¡ç™»å½•å°†è‡ªåŠ¨åˆ›å»ºè´¦å·<br>
          (ä½¿ç”¨æ‰‹æœºå·+å¯†ç æ¨¡å¼)
        </p>
      </el-form>
    </div>
  </div>
</template>

<script setup>
import { ref } from 'vue'
import { supabase } from '../lib/supabase'
import { ElMessage } from 'element-plus'

const phone = ref('')
const password = ref('')
const loading = ref(false)

// è™šæ‹ŸåŸŸååç¼€ï¼ˆç”¨æˆ·ä¸å¯è§ï¼Œç”¨äºæ»¡è¶³Supabaseé‚®ç®±æ ¼å¼è¦æ±‚ï¼‰
const DOMAIN_SUFFIX = '@camel.local'

const handleLogin = async () => {
  // 1. ç®€å•çš„æ‰‹æœºå·æ ¡éªŒ
  if (!/^1[3-9]\d{9}$/.test(phone.value)) {
    return ElMessage.warning('è¯·è¾“å…¥æ­£ç¡®çš„11ä½æ‰‹æœºå·')
  }
  if (password.value.length < 6) {
    return ElMessage.warning('å¯†ç è‡³å°‘éœ€è¦6ä½')
  }

  loading.value = true
  const email = phone.value + DOMAIN_SUFFIX // è‡ªåŠ¨æ‹¼æ¥

  try {
    // å°è¯•ç™»å½•
    const { error } = await supabase.auth.signInWithPassword({
      email: email,
      password: password.value,
    })
    
    if (error) {
      if (error.message.includes('Invalid login credentials')) {
        const { error: signUpError } = await supabase.auth.signUp({
          email: email,
          password: password.value,
          // ğŸ’¡ æ–°å¢ï¼šæ˜¾å¼å‘Šè¯‰ Supabase ä¸éœ€è¦å…ƒæ•°æ®
          options: {
            data: {
              phone_number: phone.value // å­˜ä¸€ä¸‹çº¯æ‰‹æœºå·ï¼Œæ–¹ä¾¿ä»¥åæŸ¥
            }
          }
        })
        if (signUpError) throw signUpError
        
        // ğŸ”´ ä¿®æ”¹æç¤ºè¯­ï¼šå»æ‰â€œè¯·æ£€æŸ¥é‚®ç®±â€çš„è¯´æ³•
        ElMessage.success('æ³¨å†ŒæˆåŠŸï¼æ­£åœ¨è‡ªåŠ¨ç™»å½•...')
        
        // æ³¨å†ŒæˆåŠŸåï¼ŒSupabase v2 æœ‰æ—¶éœ€è¦å†æ¬¡å‘èµ·ç™»å½•ï¼Œæˆ–è€…è‡ªåŠ¨ç™»å½•
        // æˆ‘ä»¬è¿™é‡Œç¨³å¦¥èµ·è§ï¼Œå¦‚æœ session æ²¡è‡ªåŠ¨å»ºç«‹ï¼Œæ‰‹åŠ¨å†è°ƒä¸€æ¬¡ç™»å½•
        const { data: loginData } = await supabase.auth.signInWithPassword({
          email: email,
          password: password.value,
        })
        
      } else {
        throw error
      }
    } else {
      ElMessage.success('ç™»å½•æˆåŠŸ')
    }
  } catch (err) {
    console.error(err)
    ElMessage.error('æ“ä½œå¤±è´¥ï¼š' + (err.message === 'User already registered' ? 'å¯†ç é”™è¯¯' : err.message))
  } finally {
    loading.value = false
  }
}
</script>

==================================================

File: src\components\SettingsModal.vue
--------------------------------------------------
<template>
  <el-dialog v-model="visible" title="ç»è¥è®¾ç½®" width="90%" style="max-width: 400px;" center destroy-on-close>
    
    <div class="mb-6 bg-orange-50 p-3 rounded-lg text-sm text-orange-800">
      <el-icon><InfoFilled /></el-icon> è¿™é‡Œçš„æ•°æ®å˜åŠ¨ä¼šå½±å“åç»­çš„ç»Ÿè®¡ï¼Œè¯·å¦‚å®å¡«å†™ã€‚
    </div>

    <el-form label-position="top">
      <h3 class="font-bold border-l-4 border-orange-500 pl-2 mb-3">ğŸª é©¼ç¾¤è§„æ¨¡</h3>
      <el-form-item label="éª†é©¼æ€»æ•° (å³°)">
        <el-input-number v-model="form.total_camels" :min="1" size="large" style="width: 100%" />
      </el-form-item>
      <el-form-item label="æ­£åœ¨äº§å¥¶ (å³°)">
        <el-input-number v-model="form.milking_camels" :min="0" size="large" style="width: 100%" />
      </el-form-item>

      <h3 class="font-bold border-l-4 border-blue-500 pl-2 mb-3 mt-6">ğŸ’° æ—¥å¸¸å›ºå®šå¼€é”€</h3>
      <p class="text-xs text-gray-400 mb-2">åŒ…æ‹¬ï¼šäººå·¥è´¹ã€ä¼™é£Ÿè´¹ã€æ°´ç”µè´¹ç­‰æ¯å¤©å¿…é¡»èŠ±çš„é’±ã€‚</p>
      <el-form-item label="æ¯æ—¥å›ºå®šæ”¯å‡º (å…ƒ/å¤©)">
        <el-input-number v-model="form.daily_fixed_cost" :min="0" size="large" style="width: 100%" />
      </el-form-item>
    </el-form>

    <template #footer>
      <el-button @click="visible = false" size="large">å–æ¶ˆ</el-button>
      <el-button type="primary" @click="save" :loading="loading" size="large">ä¿å­˜è®¾ç½®</el-button>
    </template>
  </el-dialog>
</template>

<script setup>
import { ref, reactive } from 'vue'
import { supabase } from '../lib/supabase'
import { InfoFilled } from '@element-plus/icons-vue'
import { ElMessage } from 'element-plus'

const visible = ref(false)
const loading = ref(false)
const form = reactive({ total_camels: 0, milking_camels: 0, daily_fixed_cost: 0 })
const emit = defineEmits(['saved'])

const open = async () => {
  visible.value = true
  // åŠ è½½ç°æœ‰è®¾ç½®
  const { data: { user } } = await supabase.auth.getUser()
  const { data } = await supabase.from('settings').select('*').eq('user_id', user.id).single()
  if (data) {
    form.total_camels = data.total_camels
    form.milking_camels = data.milking_camels
    form.daily_fixed_cost = data.daily_fixed_cost || 0
  }
}

const save = async () => {
  loading.value = true
  const { data: { user } } = await supabase.auth.getUser()
  
  // upsert: æœ‰åˆ™æ›´æ–°ï¼Œæ— åˆ™æ’å…¥
  const { error } = await supabase.from('settings').upsert({
    user_id: user.id,
    total_camels: form.total_camels,
    milking_camels: form.milking_camels,
    daily_fixed_cost: form.daily_fixed_cost
  }, { onConflict: 'user_id' })

  if (error) ElMessage.error('ä¿å­˜å¤±è´¥')
  else {
    ElMessage.success('ä¿å­˜æˆåŠŸ')
    visible.value = false
    emit('saved') // é€šçŸ¥çˆ¶ç»„ä»¶æ›´æ–°æ•°æ®
  }
  loading.value = false
}

defineExpose({ open })
</script>

==================================================

File: src\components\SetupWizard.vue
--------------------------------------------------
<template>
  <el-dialog v-model="visible" title="åˆå§‹åŒ–æ‚¨çš„é©¼åœº" width="95%" center :close-on-click-modal="false" :show-close="false" destroy-on-close>
    
    <div class="h-[60vh] overflow-y-auto px-1">
      <!-- ç¬¬ä¸€æ­¥ï¼šè§„æ¨¡ä¸æ”¶å…¥å‚æ•° -->
      <div class="mb-6 bg-blue-50 p-4 rounded-xl border border-blue-100">
        <h3 class="font-bold text-blue-800 mb-3 text-sm flex items-center">
          <span class="text-lg mr-2">ğŸª</span> åŸºç¡€è§„æ¨¡ä¸æ”¶å…¥é¢„ä¼°
        </h3>
        <div class="space-y-4">
          <div class="grid grid-cols-2 gap-3">
            <el-form-item label="æ€»é©¼æ•° (å³°)">
              <el-input-number v-model="form.total_camels" :min="1" style="width:100%" :controls="false" />
            </el-form-item>
            <el-form-item label="äº§å¥¶é©¼æ•° (å³°)">
              <el-input-number v-model="form.milking_camels" :min="0" style="width:100%" :controls="false" />
            </el-form-item>
          </div>
          
          <div class="bg-white p-3 rounded-lg border border-blue-200">
            <div class="text-xs text-blue-500 font-bold mb-2">å–å¥¶æƒ…å†µ</div>
            <div class="flex items-center gap-2 mb-2">
              <span class="text-sm text-gray-600 whitespace-nowrap">æ¯</span>
              <el-input-number v-model="form.milk_frequency" :min="1" size="small" style="width: 60px" :controls="false" />
              <span class="text-sm text-gray-600 whitespace-nowrap">å¤©ï¼Œäº¤ä¸€æ¬¡å¥¶</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-sm text-gray-600 whitespace-nowrap">æ¯æ¬¡äº¤</span>
              <el-input-number v-model="form.milk_quantity_per_time" :min="0" size="small" style="width: 70px" :controls="false" />
              <span class="text-sm text-gray-600 whitespace-nowrap">å…¬æ–¤ (å•ä»·:</span>
              <el-input-number v-model="form.milk_price" :min="0" size="small" style="width: 50px" :controls="false" />
              <span class="text-sm text-gray-600">å…ƒ)</span>
            </div>
            <div class="mt-2 text-right text-xs text-blue-600 font-bold border-t border-blue-100 pt-1">
              æ—¥å‡æ”¶å…¥: Â¥ {{ dailyMilkIncome }}
            </div>
          </div>
        </div>
      </div>

      <!-- ç¬¬äºŒæ­¥ï¼šæ”¯å‡ºæ¨¡æ¿ -->
      <div class="bg-orange-50 p-4 rounded-xl border border-orange-100">
        <h3 class="font-bold text-orange-800 mb-3 text-sm flex justify-between items-center">
          <span>ğŸ’° æ¯æ—¥å›ºå®šæ”¯å‡ºæ¨¡æ¿</span>
          <span class="text-xs font-normal bg-orange-100 px-2 py-0.5 rounded text-orange-600">å¯è‡ªç”±ä¿®æ”¹åç§°</span>
        </h3>
        
        <div v-for="(item, index) in form.template" :key="index" class="mb-3 bg-white p-3 rounded shadow-sm border border-orange-100">
          <div class="flex justify-between items-center mb-2 gap-2">
            <el-input v-model="item.name" placeholder="è¯·è¾“å…¥é¡¹ç›®åç§°" size="small" class="font-bold" />
            <el-button type="danger" link size="small" @click="removeItem(index)">åˆ é™¤</el-button>
          </div>
          
          <div class="flex gap-2">
             <div class="flex-1">
               <div class="text-xs text-gray-400 mb-1">æ•°é‡/é‡é‡</div>
               <el-input-number v-model="item.quantity" :min="0" size="small" style="width:100%" :controls="false" />
             </div>
             <div class="flex-1">
               <div class="text-xs text-gray-400 mb-1">å•ä»·</div>
               <el-input-number v-model="item.unit_price" :min="0" size="small" style="width:100%" :controls="false" />
             </div>
             <div class="w-16 text-right">
               <div class="text-xs text-gray-400 mb-1">å°è®¡</div>
               <div class="font-bold text-orange-600 pt-1">Â¥{{ (item.quantity * item.unit_price).toFixed(0) }}</div>
             </div>
          </div>
        </div>
        
        <el-button class="w-full mt-2 border-dashed bg-white" @click="addItem">
          <span class="text-orange-500 font-bold">+ æ·»åŠ å…¶ä»–æ”¯å‡ºé¡¹</span>
        </el-button>
      </div>
    </div>

    <div class="py-4 bg-white border-t mt-2">
      <div class="flex justify-between text-sm mb-2 px-2">
        <span class="text-gray-500">é¢„ä¼°æ—¥å‡€åˆ© (æ”¶å…¥-æ”¯å‡º):</span>
        <span class="font-bold text-lg" :class="dailyProfit >= 0 ? 'text-green-600' : 'text-red-500'">
          Â¥ {{ dailyProfit }}
        </span>
      </div>
      <el-button type="primary" size="large" class="w-full font-bold" @click="saveSettings" :loading="loading">
        ä¿å­˜å¹¶è‡ªåŠ¨ç”Ÿæˆä»Šæ—¥è´¦å•
      </el-button>
    </div>
  </el-dialog>
</template>

<script setup>
import { ref, reactive, computed } from 'vue'
import { supabase } from '../lib/supabase'
import { ElMessage } from 'element-plus'

const visible = ref(false)
const loading = ref(false)
const emit = defineEmits(['finish'])

// é¢„è®¾æ¨¡æ¿
const defaultItems = [
  { name: 'è±†ç²•', quantity: 1, unit_price: 170 },
  { name: 'è‘µèŠ±å¤´', quantity: 1, unit_price: 50 },
  { name: 'é¢—ç²’é¥²æ–™', quantity: 1, unit_price: 150 },
  { name: 'ç‡•éº¦è‰', quantity: 2, unit_price: 50 },
  { name: 'è‹œè“¿è‰', quantity: 3, unit_price: 50 },
  { name: 'é’å‚¨è‰', quantity: 6, unit_price: 50 },
  { name: 'äººå·¥å·¥èµ„', quantity: 1, unit_price: 334 },
  { name: 'æ°´ç”µè´¹', quantity: 1, unit_price: 30 },
  { name: 'ç‡ƒæ²¹', quantity: 1, unit_price: 30 },
]

const form = reactive({
  total_camels: 100,
  milking_camels: 20,
  milk_frequency: 1, // å‡ å¤©äº¤ä¸€æ¬¡
  milk_quantity_per_time: 40, // æ¯æ¬¡äº¤å¤šå°‘
  milk_price: 30,
  template: JSON.parse(JSON.stringify(defaultItems))
})

// è®¡ç®—æ—¥å‡å¥¶æ”¶å…¥
const dailyMilkIncome = computed(() => {
  if (!form.milk_frequency || form.milk_frequency === 0) return 0
  return ((form.milk_quantity_per_time / form.milk_frequency) * form.milk_price).toFixed(0)
})

const totalDailyCost = computed(() => {
  return form.template.reduce((sum, item) => sum + (item.quantity * item.unit_price), 0)
})

const dailyProfit = computed(() => {
  return (Number(dailyMilkIncome.value) - totalDailyCost.value).toFixed(0)
})

const check = async () => {
  const { data: { user } } = await supabase.auth.getUser()
  if (!user) return
  // ä½¿ç”¨ maybeSingle é˜²æ­¢ 406 é”™è¯¯
  const { data } = await supabase.from('settings').select('*').eq('user_id', user.id).maybeSingle()
  // å¦‚æœæ²¡æœ‰è®¾ç½®ï¼Œæˆ–è€… daily_template æ˜¯ç©ºçš„ï¼Œå°±æ˜¾ç¤ºå‘å¯¼
  if (!data || !data.daily_template) visible.value = true
}

const addItem = () => {
  form.template.push({ name: '', quantity: 1, unit_price: 0 })
}

const removeItem = (index) => {
  form.template.splice(index, 1)
}

const saveSettings = async () => {
  // ç®€å•æ ¡éªŒ
  if (form.template.some(item => !item.name || item.name.trim() === '')) {
    return ElMessage.warning('è¯·ç¡®ä¿æ‰€æœ‰æ”¯å‡ºé¡¹éƒ½æœ‰åç§°')
  }

  loading.value = true
  try {
    const { data: { user } } = await supabase.auth.getUser()
    
    // 1. ä¿å­˜è®¾ç½®
    const settingsData = {
      user_id: user.id,
      total_camels: form.total_camels,
      milking_camels: form.milking_camels,
      daily_template: form.template,
      milk_price: form.milk_price,
      milk_frequency: form.milk_frequency,
      milk_quantity_per_time: form.milk_quantity_per_time
    }

    const { error: settingsError } = await supabase.from('settings').upsert(settingsData, { onConflict: 'user_id' })
    if (settingsError) throw settingsError

    // 2. è‡ªåŠ¨ç”Ÿæˆä»Šæ—¥è´¦å• (å®è´¦)
    const today = new Date().toISOString().slice(0, 10)
    // æ£€æŸ¥ä»Šå¤©æ˜¯å¦å·²ç»æœ‰æ—¥å¸¸æ”¯å‡ºäº†ï¼Œé˜²æ­¢é‡å¤ç”Ÿæˆ (è™½ç„¶åˆå§‹åŒ–é€šå¸¸æ˜¯æ–°ç”¨æˆ·ï¼Œä½†é˜²å®ˆä¸€ä¸‹æ›´å¥½)
    const { count } = await supabase.from('cost').select('*', { count: 'exact', head: true }).eq('date', today).eq('cost_type', 'æ—¥å¸¸æ”¯å‡º')
    
    if (count === 0) {
      const records = form.template.map(item => ({
        user_id: user.id,
        date: today,
        category: item.name,
        quantity: item.quantity,
        unit_price: item.unit_price,
        amount: item.quantity * item.unit_price,
        cost_type: 'æ—¥å¸¸æ”¯å‡º',
        weight: 0 
      }))
      
      const { error: costError } = await supabase.from('cost').insert(records)
      if (costError) throw costError
    }

    ElMessage.success('åˆå§‹åŒ–å®Œæˆï¼Œä»Šæ—¥è´¦å•å·²è‡ªåŠ¨ç”Ÿæˆï¼')
    visible.value = false
    emit('finish')
    
  } catch (err) {
    console.error(err)
    ElMessage.error('ä¿å­˜å¤±è´¥: ' + err.message)
  } finally {
    loading.value = false
  }
}

defineExpose({ check })
</script>

==================================================

File: src\components\Square.vue
--------------------------------------------------
<template>
  <div class="p-4 bg-gray-50 min-h-screen">
    <!-- é¡¶éƒ¨æ ‡é¢˜ -->
    <div class="flex justify-between items-center mb-4 sticky top-0 bg-gray-50 z-10 py-2">
      <h2 class="text-xl font-bold text-gray-800">é©¼æˆ·å¹¿åœº</h2>
      <el-button type="primary" size="small" round @click="showPostModal = true">
        <el-icon class="mr-1"><Edit /></el-icon> å‘å¸ƒ
      </el-button>
    </div>

    <!-- åˆ†ç±»æ ‡ç­¾ -->
    <div class="flex gap-2 mb-4 overflow-x-auto pb-2">
      <el-tag 
        v-for="type in types" :key="type"
        :effect="activeType === type ? 'dark' : 'plain'"
        class="cursor-pointer"
        @click="filterType(type)"
      >
        {{ type }}
      </el-tag>
    </div>

    <!-- å¸–å­åˆ—è¡¨ -->
    <div v-loading="loading" class="space-y-3">
      <div v-for="post in posts" :key="post.id" class="bg-white p-4 rounded-lg shadow-sm border border-gray-100">
        <div class="flex justify-between items-start mb-2">
          <el-tag size="small" :type="getTagType(post.type)">{{ post.type }}</el-tag>
          <span class="text-xs text-gray-400">{{ formatDate(post.created_at) }}</span>
        </div>
        <h3 class="font-bold text-lg text-gray-800 mb-2">{{ post.title }}</h3>
        <p class="text-gray-600 text-sm mb-3 whitespace-pre-wrap">{{ post.content }}</p>
        
        <div class="border-t pt-2 flex justify-between items-center mt-2">
          <span class="text-sm text-gray-500">è”ç³»äººï¼šé©¼å‹</span>
          <a :href="'tel:' + post.contact_info" class="text-blue-600 text-sm font-bold flex items-center">
            <el-icon class="mr-1"><Phone /></el-icon> æ‹¨æ‰“ {{ post.contact_info }}
          </a>
        </div>
      </div>
      <el-empty v-if="!loading && posts.length === 0" description="æš‚æ— ä¿¡æ¯ï¼Œå¿«æ¥å‘å¸ƒç¬¬ä¸€æ¡å§" />
    </div>

    <!-- å‘å¸ƒå¼¹çª— -->
    <el-dialog v-model="showPostModal" title="å‘å¸ƒä¿¡æ¯" width="90%" style="max-width:500px">
      <el-form label-position="top">
        <el-form-item label="ç±»å‹">
          <el-radio-group v-model="form.type">
            <el-radio-button label="æ‹›è˜" />
            <el-radio-button label="å‡ºç§Ÿ" />
            <el-radio-button label="æ±‚åŠ©" />
            <el-radio-button label="å¹¿å‘Š" />
          </el-radio-group>
        </el-form-item>
        <el-form-item label="æ ‡é¢˜">
          <el-input v-model="form.title" placeholder="å¦‚ï¼šæ€¥æ‹›å…»æ®–å·¥ä¸¤å" />
        </el-form-item>
        <el-form-item label="è¯¦æƒ…">
          <el-input v-model="form.content" type="textarea" rows="3" placeholder="è¯·æè¿°å…·ä½“è¦æ±‚..." />
        </el-form-item>
        <el-form-item label="è”ç³»ç”µè¯">
          <el-input v-model="form.contact_info" placeholder="æ–¹ä¾¿ä»–äººè”ç³»ä½ " type="tel" />
        </el-form-item>
      </el-form>
      <template #footer>
        <el-button @click="showPostModal = false">å–æ¶ˆ</el-button>
        <el-button type="primary" :loading="submitting" @click="submitPost">å‘å¸ƒ</el-button>
      </template>
    </el-dialog>
  </div>
</template>

<script setup>
import { ref, reactive, onMounted } from 'vue'
import { supabase } from '../lib/supabase'
import { Edit, Phone } from '@element-plus/icons-vue'
import { ElMessage } from 'element-plus'

const types = ['å…¨éƒ¨', 'æ‹›è˜', 'å‡ºç§Ÿ', 'æ±‚åŠ©', 'å¹¿å‘Š']
const activeType = ref('å…¨éƒ¨')
const posts = ref([])
const loading = ref(false)
const showPostModal = ref(false)
const submitting = ref(false)

const form = reactive({ type: 'æ‹›è˜', title: '', content: '', contact_info: '' })

// 1. è·å–å¸–å­
const fetchPosts = async () => {
  loading.value = true
  let query = supabase.from('posts').select('*').order('created_at', { ascending: false })
  
  if (activeType.value !== 'å…¨éƒ¨') {
    query = query.eq('type', activeType.value)
  }
  
  const { data, error } = await query
  if (!error) posts.value = data
  loading.value = false
}

// 2. ç­›é€‰
const filterType = (type) => {
  activeType.value = type
  fetchPosts()
}

// 3. å‘å¸ƒ
const submitPost = async () => {
  const { data: { user }, error: userError } = await supabase.auth.getUser()
  
  // å¦‚æœæœåŠ¡å™¨è¿”å› 403 æˆ–è€…æ²¡æœ‰ç”¨æˆ·å¯¹è±¡ï¼Œè¯´æ˜ Token åäº†
  if (userError || !user) {
    console.error('èº«ä»½éªŒè¯å¤±è´¥:', userError)
    ElMessage.error('æ‚¨çš„ç™»å½•çŠ¶æ€å·²å¤±æ•ˆï¼Œè¯·ç‚¹å‡»åº•éƒ¨"é€€å‡º"åé‡æ–°ç™»å½•')
    submitting.value = false
    return // ç›´æ¥ç»“æŸï¼Œä¸å¾€ä¸‹æ‰§è¡Œï¼Œé˜²æ­¢æŠ¥é”™
  }
  
  const { error } = await supabase.from('posts').insert([{
    user_id: user.id,
    ...form
  }])

  if (error) {
    ElMessage.error('å‘å¸ƒå¤±è´¥')
  } else {
    ElMessage.success('å‘å¸ƒæˆåŠŸ')
    showPostModal.value = false
    // æ¸…ç©ºè¡¨å•
    form.title = ''
    form.content = ''
    fetchPosts()
  }
  submitting.value = false
}

// å·¥å…·å‡½æ•°
const getTagType = (t) => {
  const map = { 'æ‹›è˜': 'success', 'å‡ºç§Ÿ': 'warning', 'æ±‚åŠ©': 'danger', 'å¹¿å‘Š': 'info' }
  return map[t] || ''
}
const formatDate = (str) => new Date(str).toLocaleDateString()

onMounted(fetchPosts)
</script>

==================================================

File: src\components\YearlyReportModal.vue
--------------------------------------------------
<template>
  <el-dialog v-model="visible" title="å¹´åº¦è´¦æœ¬ (ä»Šå¹´)" width="95%" style="max-width: 500px;" center>
    <div v-loading="loading">
      
      <!-- 1. é¥²æ–™ä¸“å±ç»Ÿè®¡ -->
      <div class="bg-green-50 p-4 rounded-xl mb-6 border border-green-100">
        <h3 class="font-bold text-green-800 mb-2 flex items-center">
          ğŸŒ¿ é¥²æ–™æ€»è®¡
        </h3>
        <div class="flex justify-between items-end border-b border-green-200 pb-2 mb-2">
          <span class="text-gray-600">æ€»é‡é‡</span>
          <span class="text-xl font-bold text-green-700">{{ totalFeedWeight }} å¨</span>
        </div>
        <div class="flex justify-between items-end">
          <span class="text-gray-600">æ€»èŠ±è´¹</span>
          <span class="text-xl font-bold text-green-700">Â¥ {{ formatNumber(totalFeedCost) }}</span>
        </div>
      </div>

      <!-- 2. åˆ†ç±»æˆæœ¬æ’è¡Œæ¦œ -->
      <h3 class="font-bold text-gray-800 mb-3 border-l-4 border-orange-500 pl-2">å„é¡¹æˆæœ¬æ’è¡Œ</h3>
      <div class="space-y-3">
        <div v-for="(item, index) in costRank" :key="index" class="flex items-center justify-between bg-white p-3 rounded shadow-sm border">
          <div class="flex items-center gap-3">
            <span class="text-gray-400 font-bold w-4">{{ index + 1 }}</span>
            <span class="font-bold text-gray-700">{{ item.name }}</span>
          </div>
          <div class="text-right">
             <div class="font-bold">Â¥ {{ formatNumber(item.value) }}</div>
             <div class="text-xs text-gray-400">{{ ((item.value / totalCost) * 100).toFixed(1) }}%</div>
          </div>
        </div>
      </div>

    </div>
    <template #footer>
      <el-button @click="visible = false" size="large" class="w-full">å…³é—­</el-button>
    </template>
  </el-dialog>
</template>

<script setup>
import { ref, computed } from 'vue'
import { supabase } from '../lib/supabase'

const visible = ref(false)
const loading = ref(false)
const rawCosts = ref([])

const open = () => {
  visible.value = true
  fetchYearData()
}

const fetchYearData = async () => {
  loading.value = true
  const startOfYear = new Date(new Date().getFullYear(), 0, 1).toISOString()
  
  const { data } = await supabase
    .from('cost')
    .select('*')
    .gte('date', startOfYear)
  
  rawCosts.value = data || []
  loading.value = false
}

// ç»Ÿè®¡é€»è¾‘
const totalFeedWeight = computed(() => {
  // ç­›é€‰æ‰€æœ‰é¥²æ–™ï¼Œç´¯åŠ é‡é‡
  const feeds = rawCosts.value.filter(c => c.category.includes('é¥²æ–™') || c.category.includes('è‰') || c.category.includes('ç‰ç±³'))
  return feeds.reduce((sum, item) => sum + (Number(item.weight) || 0), 0)
})

const totalFeedCost = computed(() => {
  const feeds = rawCosts.value.filter(c => c.category.includes('é¥²æ–™') || c.category.includes('è‰') || c.category.includes('ç‰ç±³'))
  return feeds.reduce((sum, item) => sum + Number(item.amount), 0)
})

const totalCost = computed(() => rawCosts.value.reduce((s, i) => s + i.amount, 0))

const costRank = computed(() => {
  const map = {}
  rawCosts.value.forEach(item => {
    // ç®€å•å½’ç±»ï¼šå¦‚æœæ˜¯å…·ä½“é¥²æ–™åï¼Œç»Ÿä¸€å½’ä¸ºâ€œé¥²æ–™â€ä»¥ä¾¿çœ‹æ€»æ•°ï¼Œæˆ–è€…æŒ‰åŸåæ˜¾ç¤º
    // è¿™é‡ŒæŒ‰åŸåæ˜¾ç¤ºï¼Œç”¨æˆ·æƒ³çœ‹ç»†èŠ‚
    map[item.category] = (map[item.category] || 0) + item.amount
  })
  return Object.keys(map)
    .map(k => ({ name: k, value: map[k] }))
    .sort((a, b) => b.value - a.value)
})

const formatNumber = (n) => n.toLocaleString()

defineExpose({ open })
</script>

==================================================

File: src\lib\supabase.js
--------------------------------------------------
import { createClient } from '@supabase/supabase-js'

const supabaseKey = import.meta.env.VITE_SUPABASE_KEY
const rawUrl = import.meta.env.VITE_SUPABASE_URL

// æ ¸å¿ƒé€»è¾‘ï¼š
// 1. å¦‚æœæ˜¯ç”Ÿäº§ç¯å¢ƒ (PROD)ï¼Œä½¿ç”¨å½“å‰ç½‘ç«™åŸŸå + /api/supabase ä½œä¸ºä»£ç†åœ°å€
// 2. å¦‚æœæ˜¯æœ¬åœ°å¼€å‘ï¼Œç›´æ¥ä½¿ç”¨åŸå§‹ URL
const supabaseUrl = import.meta.env.PROD 
  ? (window.location.origin + '/api/supabase') 
  : rawUrl

// å®‰å…¨æ£€æŸ¥
if (!supabaseKey) {
  throw new Error('Supabase Key æœªé…ç½®')
}

export const supabase = createClient(supabaseUrl, supabaseKey)

==================================================

