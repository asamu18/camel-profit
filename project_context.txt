Project Scan Root: C:\Users\lenovo\Downloads\camel-profit-main
==================================================

File: index.html
--------------------------------------------------
<!doctype html>
<html lang="en">
  <head>
    <script src="https://cdn.tailwindcss.com"></script>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>camel-profit</title>
  </head>
  <body>
    <div id="app"></div>
    <script type="module" src="/src/main.js"></script>
  </body>
</html>


==================================================

File: package.json
--------------------------------------------------
{
  "name": "camel-profit",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "@supabase/supabase-js": "^2.87.1",
    "echarts": "^6.0.0",
    "element-plus": "^2.12.0",
    "vue": "^3.5.24",
    "vue-router": "^4.6.4",
    "xlsx": "^0.18.5"
  },
  "devDependencies": {
    "@vitejs/plugin-vue": "^6.0.1",
    "sass": "^1.96.0",
    "vite": "npm:rolldown-vite@7.2.5"
  },
  "overrides": {
    "vite": "npm:rolldown-vite@7.2.5"
  }
}


==================================================

File: README.md
--------------------------------------------------
# Vue 3 + Vite

This template should help get you started developing with Vue 3 in Vite. The template uses Vue 3 `<script setup>` SFCs, check out the [script setup docs](https://v3.vuejs.org/api/sfc-script-setup.html#sfc-script-setup) to learn more.

Learn more about IDE Support for Vue in the [Vue Docs Scaling up Guide](https://vuejs.org/guide/scaling-up/tooling.html#ide-support).


==================================================

File: vercel.json
--------------------------------------------------
{
  "rewrites": [
    {
      "source": "/api/supabase/:match*",
      "destination": "https://nzxfchqcvlyulnopifon.supabase.co/:match*"
    }
  ]
}

==================================================

File: vite.config.js
--------------------------------------------------
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'

// https://vite.dev/config/
export default defineConfig({
  plugins: [vue()],
})


==================================================

File: src\App.vue
--------------------------------------------------
<template>
  <Dashboard />
</template>

<script setup>
import Dashboard from './components/Dashboard.vue'
</script>

<style>
/* ç®€å•çš„å…¨å±€èƒŒæ™¯è‰² */
body {
  margin: 0;
  background-color: #f5f7fa;
}
</style>

==================================================

File: src\main.js
--------------------------------------------------
import { createApp } from 'vue'
import App from './App.vue'
import ElementPlus from 'element-plus'
import 'element-plus/dist/index.css'

const app = createApp(App)
app.use(ElementPlus)
app.mount('#app')


==================================================

File: src\style.css
--------------------------------------------------
:root {
  font-family: system-ui, Avenir, Helvetica, Arial, sans-serif;
  line-height: 1.5;
  font-weight: 400;

  color-scheme: light dark;
  color: rgba(255, 255, 255, 0.87);
  background-color: #242424;

  font-synthesis: none;
  text-rendering: optimizeLegibility;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

a {
  font-weight: 500;
  color: #646cff;
  text-decoration: inherit;
}
a:hover {
  color: #535bf2;
}

body {
  margin: 0;
  display: flex;
  place-items: center;
  min-width: 320px;
  min-height: 100vh;
}

h1 {
  font-size: 3.2em;
  line-height: 1.1;
}

button {
  border-radius: 8px;
  border: 1px solid transparent;
  padding: 0.6em 1.2em;
  font-size: 1em;
  font-weight: 500;
  font-family: inherit;
  background-color: #1a1a1a;
  cursor: pointer;
  transition: border-color 0.25s;
}
button:hover {
  border-color: #646cff;
}
button:focus,
button:focus-visible {
  outline: 4px auto -webkit-focus-ring-color;
}

.card {
  padding: 2em;
}

#app {
  max-width: 1280px;
  margin: 0 auto;
  padding: 2rem;
  text-align: center;
}

@media (prefers-color-scheme: light) {
  :root {
    color: #213547;
    background-color: #ffffff;
  }
  a:hover {
    color: #747bff;
  }
  button {
    background-color: #f9f9f9;
  }
}


==================================================

File: src\api\dataService.js
--------------------------------------------------
import { supabase } from '../lib/supabase'

export const dataService = {
  // 1. æ–°å¢æ”¶å…¥
  async addIncome(record) {
    const { data, error } = await supabase.from('income').insert([record]).select()
    if (error) throw error
    return data
  },

  // 2. æ–°å¢æˆæœ¬
  async addCost(record) {
    const { data, error } = await supabase.from('cost').insert([record]).select()
    if (error) throw error
    return data
  },

  // 3. æŒ‰æœˆä»½è·å– (ä¿®å¤ç‰ˆï¼šè‡ªåŠ¨è®¡ç®—æœˆåº•æ—¥æœŸ)
  async getDataByMonth(monthStr) {
    // monthStr æ ¼å¼ä¸º "2025-04"
    const [year, month] = monthStr.split('-')
    
    // JSæŠ€å·§ï¼šnew Date(year, month, 0) ä¼šè‡ªåŠ¨å¾—åˆ°è¯¥æœˆçš„æœ€åä¸€å¤©
    // è¿™é‡Œçš„ month æ˜¯å­—ç¬¦ä¸² "04"ï¼Œç›´æ¥è½¬æ•°å­—ä½œä¸ºä¸‹ä¸ªæœˆçš„ç´¢å¼•ï¼Œåˆšå¥½ç¬¦åˆ Date çš„é€»è¾‘
    const lastDay = new Date(year, month, 0).getDate() 
    
    const startDate = `${monthStr}-01`
    const endDate = `${monthStr}-${lastDay}` // åŠ¨æ€ç”Ÿæˆ 2025-04-30

    const [incomeRes, costRes] = await Promise.all([
      supabase.from('income').select('*').gte('date', startDate).lte('date', endDate).order('date', { ascending: false }),
      supabase.from('cost').select('*').gte('date', startDate).lte('date', endDate).order('date', { ascending: false })
    ])

    if (incomeRes.error) throw incomeRes.error
    if (costRes.error) throw costRes.error

    return { income: incomeRes.data, cost: costRes.data }
  },

  // --- NEW: 4. è·å–æœ€è¿‘ 6 ä¸ªæœˆçš„è¶‹åŠ¿æ•°æ® ---
  async getTrendData() {
    // è®¡ç®—6ä¸ªæœˆå‰çš„æ—¥æœŸ
    const d = new Date()
    d.setMonth(d.getMonth() - 5)
    d.setDate(1)
    const startDate = d.toISOString().slice(0, 10) // æ ¼å¼ 2023-05-01

    // æ‹‰å–è¿™æœŸé—´æ‰€æœ‰çš„æ”¶æ”¯
    const [incomeRes, costRes] = await Promise.all([
      supabase.from('income').select('date, amount').gte('date', startDate),
      supabase.from('cost').select('date, amount').gte('date', startDate)
    ])
    
    return { income: incomeRes.data, cost: costRes.data }
  },
  

  // --- NEW: 5. åˆ é™¤è®°å½• (é€šç”¨æ–¹æ³•) ---
  async deleteRecord(table, id) {
    // table: 'income' æˆ– 'cost'
    // id: è¦åˆ é™¤çš„è®°å½•ID
    const { error } = await supabase
      .from(table)
      .delete()
      .eq('id', id)
    
    if (error) throw error
    return true
  }

}

==================================================

File: src\components\AddRecordModal.vue
--------------------------------------------------
<template>
  <el-dialog
    v-model="visible"
    title="æ–°å¢è®°è´¦"
    width="90%" 
    style="max-width: 500px;" 
    center
    destroy-on-close
  >
    <el-form :model="form" label-width="80px">
      <!-- 1. æ”¶æ”¯ç±»å‹åˆ‡æ¢ -->
      <el-form-item label="ç±»å‹">
        <el-radio-group v-model="form.type" @change="handleTypeChange">
          <el-radio-button label="income">æ”¶å…¥ (å¦‚é©¼å¥¶)</el-radio-button>
          <el-radio-button label="cost">æˆæœ¬ (å¦‚é¥²æ–™)</el-radio-button>
        </el-radio-group>
      </el-form-item>

      <!-- 2. å…·ä½“åˆ†ç±» (æ ¹æ®ç±»å‹åŠ¨æ€å˜) -->
      <el-form-item label="åˆ†ç±»">
        <el-select
          v-model="form.category"
          placeholder="è¯·é€‰æ‹©"
          style="width: 100%"
          @change="autoFillCostType"
        >
          <el-option
            v-for="opt in currentOptions"
            :key="opt"
            :label="opt"
            :value="opt"
          />
        </el-select>
      </el-form-item>

      <!-- 3. æ”¶å…¥ç‰¹æœ‰å­—æ®µï¼šæ•°é‡ x å•ä»· -->
      <div v-if="form.type === 'income'" class="bg-gray-50 p-4 rounded mb-4">
        <el-form-item label="æ•°é‡">
          <el-input-number v-model="form.quantity" :min="1" style="width: 100%" />
        </el-form-item>
        <el-form-item label="å•ä»·">
          <el-input-number v-model="form.unit_price" :min="0" :precision="2" style="width: 100%" />
        </el-form-item>
        <div class="text-right text-gray-500 text-sm mt-2">
          é¢„è®¡æ”¶å…¥: <span class="text-green-600 font-bold text-lg">Â¥ {{ (form.quantity * form.unit_price).toFixed(2) }}</span>
        </div>
      </div>

      <!-- 4. æˆæœ¬ç‰¹æœ‰å­—æ®µï¼šå±æ€§ + æ€»é¢ -->
      <div v-if="form.type === 'cost'">
        <el-form-item label="å±æ€§">
          <el-tag :type="form.cost_type === 'å›ºå®šæˆæœ¬' ? 'info' : 'warning'">
            {{ form.cost_type || 'è¯·é€‰æ‹©åˆ†ç±»' }}
          </el-tag>
        </el-form-item>
        <el-form-item label="æ€»é‡‘é¢">
          <el-input-number v-model="form.amount" :min="0" :precision="2" style="width: 100%" />
        </el-form-item>
      </div>

      <el-form-item label="æ—¥æœŸ">
        <el-date-picker
          v-model="form.date"
          type="date"
          value-format="YYYY-MM-DD"
          style="width: 100%"
          :clearable="false"
        />
      </el-form-item>
    </el-form>

    <template #footer>
      <span class="dialog-footer">
        <el-button @click="visible = false">å–æ¶ˆ</el-button>
        <el-button type="primary" :loading="loading" @click="submitForm">
          ç¡®è®¤å½•å…¥
        </el-button>
      </span>
    </template>
  </el-dialog>
</template>

<script setup>
import { ref, reactive, computed } from 'vue'
import { ElMessage } from 'element-plus'
import { dataService } from '../api/dataService' // å¼•å…¥æ˜¨å¤©çš„API

// --- 1. å­—å…¸å®šä¹‰ ---
const incomeOptions = ['é©¼å¥¶é”€å”®', 'ç§é©¼äº¤æ˜“', 'è§‚å…‰é—¨ç¥¨', 'å…¶ä»–']
const costOptions = ['é¥²æ–™', 'åŒ»ç–—', 'æ°´ç”µ', 'å·¥èµ„', 'ç§Ÿé‡‘', 'è®¾å¤‡æŠ˜æ—§']
const costMap = {
  'é¥²æ–™': 'å˜åŠ¨æˆæœ¬', 'åŒ»ç–—': 'å˜åŠ¨æˆæœ¬', 'æ°´ç”µ': 'å˜åŠ¨æˆæœ¬',
  'å·¥èµ„': 'å˜åŠ¨æˆæœ¬', 'ç§Ÿé‡‘': 'å›ºå®šæˆæœ¬', 'è®¾å¤‡æŠ˜æ—§': 'å›ºå®šæˆæœ¬'
}

// --- 2. çŠ¶æ€å®šä¹‰ ---
const visible = ref(false)
const loading = ref(false)
const emit = defineEmits(['success']) // å®šä¹‰æˆåŠŸäº‹ä»¶ï¼Œé€šçŸ¥çˆ¶ç»„ä»¶åˆ·æ–°

const form = reactive({
  type: 'income',
  category: '',
  quantity: 1,
  unit_price: 0,
  amount: 0,
  cost_type: '',
  date: new Date().toISOString().slice(0, 10)
})

// --- 3. è®¡ç®—å±æ€§ ---
const currentOptions = computed(() => form.type === 'income' ? incomeOptions : costOptions)

// --- 4. é€»è¾‘æ–¹æ³• ---
const open = () => {
  visible.value = true
  // é‡ç½®éƒ¨åˆ†æ•°æ®ï¼Œä¿ç•™æ—¥æœŸ
  form.category = ''
  form.amount = 0
}

const handleTypeChange = () => {
  form.category = ''
  form.amount = 0
  form.cost_type = ''
}

// è‡ªåŠ¨å¡«å……æˆæœ¬å±æ€§ï¼ˆæ¼”ç¤ºäº®ç‚¹ï¼‰
const autoFillCostType = () => {
  if (form.type === 'cost') {
    form.cost_type = costMap[form.category] || 'å˜åŠ¨æˆæœ¬'
  }
}

const submitForm = async () => {
  if (!form.category) return ElMessage.warning('è¯·é€‰æ‹©åˆ†ç±»')
  
  loading.value = true
  try {
    // å‡†å¤‡æ•°æ®å¯¹è±¡
    const baseData = {
      date: form.date,
      category: form.category,
      amount: form.amount
    }

    if (form.type === 'income') {
      // æ”¶å…¥ï¼šè®¡ç®—æ€»é¢
      baseData.quantity = form.quantity
      baseData.unit_price = form.unit_price
      baseData.amount = form.quantity * form.unit_price // æ ¸å¿ƒï¼šè®¡ç®—åå…¥åº“
      await dataService.addIncome(baseData)
    } else {
      // æˆæœ¬ï¼šå¸¦ä¸Šcost_type
      baseData.cost_type = form.cost_type
      await dataService.addCost(baseData)
    }

    ElMessage.success('å½•å…¥æˆåŠŸï¼')
    visible.value = false
    emit('success') // æ ¸å¿ƒï¼šå‘Šè¯‰çˆ¶ç»„ä»¶â€œæˆ‘å­˜å¥½äº†ï¼Œå¿«åˆ·æ–°â€
  } catch (error) {
    console.error(error)
    ElMessage.error('å½•å…¥å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°')
  } finally {
    loading.value = false
  }
}

// æš´éœ² open æ–¹æ³•ç»™çˆ¶ç»„ä»¶è°ƒç”¨
defineExpose({ open })
</script>

==================================================

File: src\components\Dashboard.vue
--------------------------------------------------
<template>
  <div class="p-6 max-w-7xl mx-auto min-h-screen">
    
    <!-- 1. é¡¶éƒ¨æ§åˆ¶æ  (ä¿æŒä¸å˜) -->
    <div class="flex flex-col md:flex-row justify-between items-center mb-6 bg-white p-4 rounded-xl shadow-sm border border-gray-100 gap-4">
      <div class="flex items-center">
        <div class="w-10 h-10 bg-orange-500 rounded-lg flex items-center justify-center text-white font-bold text-xl mr-3">é©¼</div>
        <div>
          <h1 class="text-xl font-bold text-gray-800">é©¼åœºåˆ©æ¶¦è®¡ç®—ç³»ç»Ÿ</h1>
          <p class="text-xs text-gray-500">æ•°æ®æœˆä»½ï¼š{{ currentMonth }}</p>
        </div>
      </div>
      <div class="flex gap-3 w-full md:w-auto overflow-x-auto pb-1">
        <el-date-picker 
          v-model="currentMonth" type="month" value-format="YYYY-MM" :clearable="false"
          @change="refreshAll" placeholder="é€‰æ‹©æœˆä»½" style="width: 140px;"
        />
        <!-- ğŸ†• æ–°å¢ï¼šå¯¼å‡ºæŒ‰é’® -->
        <el-button type="success" plain @click="handleExport">
          <el-icon class="mr-1"><Download /></el-icon> å¯¼å‡º
        </el-button>
        
        <el-button type="primary" @click="handleAdd">
          <el-icon class="mr-1"><Plus /></el-icon> æ–°å¢
        </el-button>
      </div>
    </div>

    <!-- 2. æ ¸å¿ƒæŒ‡æ ‡å¡ç‰‡ (ä¿æŒä¸å˜) -->
    <el-row :gutter="20" class="mb-6">
      <el-col :xs="24" :sm="12" :md="6">
        <el-card shadow="never" class="border-l-4 border-green-500">
          <template #header><span class="text-gray-500 text-sm">æœ¬æœˆæ€»æ”¶å…¥</span></template>
          <div class="text-3xl font-bold text-gray-800">Â¥ {{ formatNumber(stats.income) }}</div>
        </el-card>
      </el-col>
      <el-col :xs="24" :sm="12" :md="6">
        <el-card shadow="never" class="border-l-4 border-gray-400">
          <template #header><span class="text-gray-500 text-sm">å›ºå®šæˆæœ¬</span></template>
          <div class="text-3xl font-bold text-gray-800">Â¥ {{ formatNumber(stats.fixedCost) }}</div>
        </el-card>
      </el-col>
      <el-col :xs="24" :sm="12" :md="6">
        <el-card shadow="never" class="border-l-4 border-orange-400">
          <template #header><span class="text-gray-500 text-sm">å˜åŠ¨æˆæœ¬</span></template>
          <div class="text-3xl font-bold text-gray-800">Â¥ {{ formatNumber(stats.variableCost) }}</div>
        </el-card>
      </el-col>
      <el-col :xs="24" :sm="12" :md="6">
        <el-card shadow="never" class="bg-gray-800 text-white border-none">
          <template #header><span class="text-gray-300 text-sm">æœ¬æœˆå‡€åˆ©æ¶¦</span></template>
          <div class="text-4xl font-bold" :class="stats.profit >= 0 ? 'text-green-400' : 'text-red-400'">
            Â¥ {{ formatNumber(stats.profit) }}
          </div>
        </el-card>
      </el-col>
    </el-row>

    <!-- 3. å¯è§†åŒ–å›¾è¡¨åŒº (NEW) -->
    <el-row :gutter="20" class="mb-6">
      <!-- å·¦ä¾§ï¼šæˆæœ¬é¥¼å›¾ -->
      <el-col :xs="24" :md="12" class="mb-6 md:mb-0">
        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100 overflow-hidden">
          <h3 class="font-bold text-gray-700 mb-4 border-l-4 border-orange-500 pl-2">æœ¬æœˆæˆæœ¬ç»“æ„</h3>
          <div id="pieChart" style="height: 350px; width: 100%;"></div>
        </div>
      </el-col>
      <!-- å³ä¾§ï¼šè¶‹åŠ¿æŸ±çŠ¶å›¾ -->
      <el-col :xs="24" :md="12" class="mb-6 md:mb-0">
        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100">
          <h3 class="font-bold text-gray-700 mb-4 border-l-4 border-blue-500 pl-2">è¿‘åŠå¹´åˆ©æ¶¦è¶‹åŠ¿</h3>
          <div id="barChart" style="height: 350px; width: 100%;"></div>
        </div>
      </el-col>
    </el-row>

    <!-- 4. æ˜ç»†æŠ¥è¡¨åŒº (Tabåˆ‡æ¢) -->
    <el-card shadow="never">
      <el-tabs v-model="activeTab">
        <el-tab-pane label="æ”¶å…¥æ˜ç»†" name="income">
          <el-table :data="rawIncome" stripe style="width: 100%" height="400">
            <el-table-column prop="date" label="æ—¥æœŸ" width="120" sortable />
            <el-table-column prop="category" label="å“ç±»" width="150">
              <template #default="scope"><el-tag effect="light">{{ scope.row.category }}</el-tag></template>
            </el-table-column>
            <el-table-column prop="quantity" label="æ•°é‡" width="120" />
            <el-table-column prop="unit_price" label="å•ä»·" width="120" />
            <el-table-column prop="amount" label="æ€»é‡‘é¢" sortable>
              <template #default="scope"><span class="font-bold text-green-600">+ Â¥{{ formatNumber(scope.row.amount) }}</span></template>
            </el-table-column>
            <!-- ğŸ†• æ–°å¢ï¼šåˆ é™¤æ“ä½œåˆ— -->
            <el-table-column label="æ“ä½œ" width="100" align="center">
              <template #default="scope">
                <!-- ä¿®æ”¹ç‚¹ï¼šå»æ‰äº† linkï¼Œå»æ‰äº† iconï¼Œä¿ç•™ type="danger" -->
                <el-button 
                  type="danger" 
                  size="small" 
                  @click="handleDelete(scope.row, 'income')"
                >
                  åˆ é™¤
                </el-button>
              </template>
            </el-table-column>
          </el-table>
        </el-tab-pane>
        
        <el-tab-pane label="æˆæœ¬æ˜ç»†" name="cost">
          <el-table :data="rawCost" stripe style="width: 100%" height="400">
            <el-table-column prop="date" label="æ—¥æœŸ" width="120" sortable />
            <el-table-column prop="category" label="é¡¹ç›®" width="150" />
            <el-table-column prop="cost_type" label="ç±»å‹" width="120">
              <template #default="scope">
                <el-tag :type="scope.row.cost_type === 'å›ºå®šæˆæœ¬' ? 'info' : 'warning'">{{ scope.row.cost_type }}</el-tag>
              </template>
            </el-table-column>
            <el-table-column prop="amount" label="æ”¯å‡ºé‡‘é¢" sortable>
              <template #default="scope"><span class="font-bold text-red-500">- Â¥{{ formatNumber(scope.row.amount) }}</span></template>
            </el-table-column>
            <!-- ğŸ†• æ–°å¢ï¼šåˆ é™¤æ“ä½œåˆ— -->
            <el-table-column label="æ“ä½œ" width="100" align="center">
              <template #default="scope">
                <!-- ä¿®æ”¹ç‚¹ï¼šå»æ‰äº† linkï¼Œå»æ‰äº† iconï¼Œä¿ç•™ type="danger" -->
                <el-button 
                  type="danger" 
                  size="small" 
                  @click="handleDelete(scope.row, 'cost')"
                >
                  åˆ é™¤
                </el-button>
              </template>
            </el-table-column>
          </el-table>
        </el-tab-pane>
      </el-tabs>
    </el-card>

    <AddRecordModal ref="addModalRef" @success="refreshAll" />
  </div>
</template>
import * as XLSX from 'xlsx' // å¼•å…¥ Excel å¤„ç†åº“
<script setup>
// 1. å¼•å…¥ Delete å›¾æ ‡
import { Plus, Download, Delete } from '@element-plus/icons-vue' 
import { ref, onMounted, computed, nextTick } from 'vue'
import * as echarts from 'echarts'
import AddRecordModal from './AddRecordModal.vue'
import * as XLSX from 'xlsx'
import { dataService } from '../api/dataService'
// 2. å¼•å…¥æ¶ˆæ¯ç¡®è®¤æ¡†
import { ElMessage, ElMessageBox } from 'element-plus'

// --- çŠ¶æ€å®šä¹‰ ---
const currentMonth = ref(new Date().toISOString().slice(0, 7))
const activeTab = ref('income')
const addModalRef = ref(null)
const rawIncome = ref([])
const rawCost = ref([])

// å›¾è¡¨å®ä¾‹
let pieChartInstance = null
let barChartInstance = null

// --- æ ¸å¿ƒè®¡ç®— ---
const stats = computed(() => {
  const incomeTotal = rawIncome.value.reduce((sum, item) => sum + Number(item.amount), 0)
  const fixedTotal = rawCost.value.filter(i => i.cost_type === 'å›ºå®šæˆæœ¬').reduce((sum, i) => sum + Number(i.amount), 0)
  const variableTotal = rawCost.value.filter(i => i.cost_type === 'å˜åŠ¨æˆæœ¬').reduce((sum, i) => sum + Number(i.amount), 0)
  return { income: incomeTotal, fixedCost: fixedTotal, variableCost: variableTotal, profit: incomeTotal - fixedTotal - variableTotal }
})

// --- æ–¹æ³• ---
const formatNumber = (num) => Number(num).toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })
const handleAdd = () => addModalRef.value.open()

// 1. è·å–å½“æœˆæ•°æ® (ç”¨äºæŒ‡æ ‡å¡ã€è¡¨æ ¼ã€é¥¼å›¾)
const fetchMonthData = async () => {
  const { income, cost } = await dataService.getDataByMonth(currentMonth.value)
  rawIncome.value = income
  rawCost.value = cost
  updatePieChart() // æ•°æ®å›æ¥åæ›´æ–°é¥¼å›¾
}

// 2. è·å–è¶‹åŠ¿æ•°æ® (ç”¨äºæŸ±çŠ¶å›¾)
const fetchTrendData = async () => {
  const { income, cost } = await dataService.getTrendData()
  updateBarChart(income, cost)
}

// åˆ·æ–°æ‰€æœ‰æ•°æ®
const refreshAll = () => {
  fetchMonthData()
  fetchTrendData()
}

// --- å›¾è¡¨é€»è¾‘ ---

// æ›´æ–°é¥¼å›¾ï¼šåŸºäºå½“æœˆ rawCost
// æ›´æ–°é¥¼å›¾
const updatePieChart = () => {
  if (!pieChartInstance) return
  
  const dist = {}
  rawCost.value.forEach(item => {
    dist[item.category] = (dist[item.category] || 0) + Number(item.amount)
  })
  
  const data = Object.keys(dist).map(k => ({ name: k, value: dist[k] }))

  pieChartInstance.setOption({
    tooltip: { trigger: 'item' },
    legend: { 
      bottom: '0%',
      left: 'center' 
    },
    color: ['#5470c6', '#91cc75', '#fac858', '#ee6666', '#73c0de'],
    series: [{
      type: 'pie', 
      radius: ['40%', '60%'], // ç¨å¾®è°ƒå¤§ä¸€ç‚¹ç‚¹ï¼Œçœ‹ç€æ›´é¥±æ»¡
      center: ['50%', '50%'], // âš ï¸ å…³é”®ä¿®å¤ï¼šå¼ºåˆ¶åœ¨å®¹å™¨æ­£ä¸­é—´
      avoidLabelOverlap: true,
      itemStyle: { borderRadius: 10, borderColor: '#fff', borderWidth: 2 },
      label: { 
        show: true, 
        formatter: '{b}: {c}'
      },
      data: data.length ? data : [{ name: 'æ— æ•°æ®', value: 0 }]
    }]
  })
}

// æ›´æ–°æŸ±çŠ¶å›¾ï¼šåŸºäºå†å²è¶‹åŠ¿æ•°æ®
// æ›´æ–°æŸ±çŠ¶å›¾ï¼šåŸºäºå†å²è¶‹åŠ¿æ•°æ®
const updateBarChart = (allIncome, allCost) => {
  if (!barChartInstance) return

  // 1. ç”Ÿæˆæœ€è¿‘ 6 ä¸ªæœˆçš„æœˆä»½æ ‡ç­¾
  const months = []
  const d = new Date()
  for (let i = 0; i < 6; i++) {
    months.unshift(d.toISOString().slice(0, 7))
    d.setMonth(d.getMonth() - 1)
  }

  // 2. è®¡ç®—æ¯ä¸ªæœˆçš„åˆ©æ¶¦
  const values = months.map(m => {
    const inc = allIncome.filter(i => i.date.startsWith(m)).reduce((s, i) => s + Number(i.amount), 0)
    const cst = allCost.filter(c => c.date.startsWith(m)).reduce((s, c) => s + Number(c.amount), 0)
    return (inc - cst).toFixed(0)
  })

  barChartInstance.setOption({
    tooltip: { trigger: 'axis' },
    // âš ï¸ å…³é”®ä¿®å¤ï¼šæ˜¾å¼å®šä¹‰ç½‘æ ¼ï¼ŒcontainLabel: true ä¼šè‡ªåŠ¨è®¡ç®—æ–‡å­—å®½åº¦ï¼Œé˜²æ­¢æº¢å‡ºæˆ–é”™ä½
    grid: { 
      top: '15%', 
      bottom: '5%', 
      left: '2%', 
      right: '2%', 
      containLabel: true 
    },
    xAxis: { 
      type: 'category', 
      data: months,
      axisTick: { alignWithLabel: true } // è®©åˆ»åº¦çº¿å’Œæ ‡ç­¾å¯¹é½
    },
    yAxis: { type: 'value' },
    series: [{
      data: values, 
      type: 'bar', 
      barWidth: '40%',
      itemStyle: { 
        color: params => {
          // è¿›é˜¶ä¼˜åŒ–ï¼šç›ˆåˆ©ç»¿è‰²ï¼ŒäºæŸçº¢è‰² (å¯é€‰)
          return params.value >= 0 ? '#3ba272' : '#ee6666'
        },
        borderRadius: [4, 4, 0, 0] 
      },
      label: { show: true, position: 'top' }
    }]
  })
}

// --- å¯¼å‡º Excel ---
const handleExport = () => {
  // 1. å‡†å¤‡ Sheet1ï¼šæœˆåº¦æ±‡æ€»æ•°æ®
  const summaryData = [
    ['æŠ¥è¡¨æœˆä»½', currentMonth.value],
    ['ç”Ÿæˆæ—¶é—´', new Date().toLocaleString()],
    [], // ç©ºè¡Œ
    ['é¡¹ç›®', 'é‡‘é¢ (å…ƒ)'],
    ['æ€»æ”¶å…¥', stats.value.income],
    ['å›ºå®šæˆæœ¬', stats.value.fixedCost],
    ['å˜åŠ¨æˆæœ¬', stats.value.variableCost],
    ['å‡€åˆ©æ¶¦', stats.value.profit]
  ]
  // å°†æ•°ç»„è½¬æ¢ä¸ºå·¥ä½œè¡¨
  const wsSummary = XLSX.utils.aoa_to_sheet(summaryData)

  // 2. å‡†å¤‡ Sheet2ï¼šè¯¦ç»†æµæ°´æ•°æ®
  // åˆå¹¶æ”¶å…¥å’Œæ”¯å‡ºï¼Œæ•´ç†æˆæ‰å¹³æ ¼å¼
  const incomeRows = rawIncome.value.map(item => ({
    æ—¥æœŸ: item.date,
    æ”¶æ”¯ç±»å‹: 'æ”¶å…¥',
    é¡¹ç›®åˆ†ç±»: item.category,
    æ•°é‡: item.quantity,
    å•ä»·: item.unit_price,
    æˆæœ¬å±æ€§: '-',
    é‡‘é¢: item.amount
  }))

  const costRows = rawCost.value.map(item => ({
    æ—¥æœŸ: item.date,
    æ”¶æ”¯ç±»å‹: 'æ”¯å‡º',
    é¡¹ç›®åˆ†ç±»: item.category,
    æ•°é‡: '-',
    å•ä»·: '-',
    æˆæœ¬å±æ€§: item.cost_type,
    é‡‘é¢: 0 - item.amount // æ”¯å‡ºæ˜¾ç¤ºä¸ºè´Ÿæ•°ï¼Œæ–¹ä¾¿ä¼šè®¡æ ¸å¯¹
  }))

  // åˆå¹¶å¹¶æŒ‰æ—¥æœŸæ’åº
  const allRows = [...incomeRows, ...costRows].sort((a, b) => new Date(a.æ—¥æœŸ) - new Date(b.æ—¥æœŸ))
  const wsDetails = XLSX.utils.json_to_sheet(allRows)

  // 3. åˆ›å»ºå·¥ä½œç°¿å¹¶æ·»åŠ  Sheet
  const wb = XLSX.utils.book_new()
  XLSX.utils.book_append_sheet(wb, wsSummary, "æœˆåº¦æ±‡æ€»")
  XLSX.utils.book_append_sheet(wb, wsDetails, "æ”¶æ”¯æ˜ç»†")

  // 4. è§¦å‘ä¸‹è½½
  XLSX.writeFile(wb, `é©¼åœºåˆ©æ¶¦æŠ¥è¡¨_${currentMonth.value}.xlsx`)
}
// --- åˆ é™¤é€»è¾‘ ---
const handleDelete = (row, type) => {
  ElMessageBox.confirm(
    'ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ã€‚',
    'è­¦å‘Š',
    {
      confirmButtonText: 'ç¡®å®šåˆ é™¤',
      cancelButtonText: 'å–æ¶ˆ',
      type: 'warning',
    }
  ).then(async () => {
    try {
      // è°ƒç”¨ API åˆ é™¤
      // type ä¼ å…¥ 'income' æˆ– 'cost'
      await dataService.deleteRecord(type, row.id)
      
      ElMessage.success('åˆ é™¤æˆåŠŸ')
      // æ ¸å¿ƒï¼šåˆ é™¤åç«‹å³åˆ·æ–°æ‰€æœ‰æ•°æ®
      refreshAll()
    } catch (error) {
      console.error(error)
      ElMessage.error('åˆ é™¤å¤±è´¥')
    }
  }).catch(() => {
    // ç”¨æˆ·ç‚¹å‡»äº†å–æ¶ˆï¼Œä¸åšä»»ä½•äº‹
  })
}

// åˆå§‹åŒ–
onMounted(() => {
  // ä½¿ç”¨ setTimeout ç¡®ä¿ DOM å¸ƒå±€å·²ç»å®Œå…¨ç¨³å®š
  setTimeout(() => {
    const pieEl = document.getElementById('pieChart')
    const barEl = document.getElementById('barChart')

    if (pieEl && barEl) {
      pieChartInstance = echarts.init(pieEl)
      barChartInstance = echarts.init(barEl)
      
      window.addEventListener('resize', () => {
        pieChartInstance && pieChartInstance.resize()
        barChartInstance && barChartInstance.resize()
      })

      refreshAll()
    }
  }, 100) // å»¶æ—¶ 100ms
})
</script>

==================================================

File: src\lib\supabase.js
--------------------------------------------------
import { createClient } from '@supabase/supabase-js'

const supabaseKey = import.meta.env.VITE_SUPABASE_KEY
const rawUrl = import.meta.env.VITE_SUPABASE_URL

// æ ¸å¿ƒé€»è¾‘ï¼š
// 1. å¦‚æœæ˜¯ç”Ÿäº§ç¯å¢ƒ (PROD)ï¼Œä½¿ç”¨å½“å‰ç½‘ç«™åŸŸå + /api/supabase ä½œä¸ºä»£ç†åœ°å€
// 2. å¦‚æœæ˜¯æœ¬åœ°å¼€å‘ï¼Œç›´æ¥ä½¿ç”¨åŸå§‹ URL
const supabaseUrl = import.meta.env.PROD 
  ? (window.location.origin + '/api/supabase') 
  : rawUrl

// å®‰å…¨æ£€æŸ¥
if (!supabaseKey) {
  throw new Error('Supabase Key æœªé…ç½®')
}

export const supabase = createClient(supabaseUrl, supabaseKey)

==================================================

